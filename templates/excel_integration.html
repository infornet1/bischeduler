<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003366">
    <title>Integración Excel - BiScheduler</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/bischeduler/static/css/styles.css">
    <link rel="stylesheet" href="/bischeduler/static/css/dark-mode.css">

    <style>
                /* User Bar Styles */
        .user-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: 25px;
            padding: 8px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-info .user-name {
            color: var(--text-primary, #212529);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-info .user-role {
            color: var(--text-secondary, #6c757d);
            font-size: 0.75rem;
        }

        .user-actions {
            display: flex;
            align-items: center;
        }

        .user-dropdown-toggle {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            cursor: pointer;
        }

        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle:active {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: var(--text-primary) !important;
        }

        .user-dropdown-toggle .fas {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .user-dropdown-toggle[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }

.excel-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: var(--spacing-lg);
        }

        .excel-card {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .excel-section {
            background: var(--bg-secondary, #f8f9fa);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            border-left: 4px solid var(--primary-color, #003366);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary, #212529);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .section-icon {
            font-size: 1.5rem;
            color: var(--primary-color, #003366);
        }

        .upload-area {
            border: 2px dashed var(--border-color, #dee2e6);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            text-align: center;
            margin-bottom: var(--spacing-md);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--primary-color, #003366);
            background: var(--bg-hover, rgba(0, 51, 102, 0.05));
        }

        .upload-area.dragover {
            border-color: var(--primary-color, #003366);
            background: var(--bg-hover, rgba(0, 51, 102, 0.1));
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-muted, #6c757d);
            margin-bottom: var(--spacing-md);
        }

        .upload-text {
            color: var(--text-secondary, #6c757d);
            margin-bottom: var(--spacing-sm);
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .btn-excel {
            background: var(--primary-color, #003366);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .btn-excel:hover {
            background: #004080;
            color: white;
            transform: translateY(-1px);
        }

        .btn-excel-secondary {
            background: transparent;
            color: var(--primary-color, #003366);
            border: 1px solid var(--primary-color, #003366);
        }

        .btn-excel-secondary:hover {
            background: var(--primary-color, #003366);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-item {
            background: var(--bg-secondary, #f8f9fa);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            text-align: center;
            border-left: 4px solid var(--primary-color, #003366);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color, #003366);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-secondary, #6c757d);
            font-size: 0.9rem;
        }

        .progress-section {
            margin-top: var(--spacing-lg);
            display: none;
        }

        .progress {
            height: 8px;
            background: var(--bg-secondary, #e9ecef);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--primary-color, #003366);
            height: 100%;
            transition: width 0.3s ease;
        }

        .result-section {
            margin-top: var(--spacing-lg);
            display: none;
        }

        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .result-details {
            background: var(--bg-secondary, #f8f9fa);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .section-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-excel {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <span class="user-name">Integración Excel</span>
            <span class="user-role">Importar/Exportar Datos</span>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="user-dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="fas fa-user-circle"></i>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <button class="dropdown-item" id="darkModeToggle">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                        <span id="darkModeText">Modo Oscuro</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/bischeduler/dashboard">
                        <i class="fas fa-home"></i> Panel Principal
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="excel-container">
        <div class="excel-card">
            <div class="header-section">
                <div>
                    <h1><i class="fas fa-file-excel"></i> Integración Excel</h1>
                    <p class="text-muted">Importación y exportación de datos escolares en formato Excel</p>
                </div>
                <a href="/bischeduler/dashboard" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>

            <!-- Statistics Section -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-item">
                    <div class="stat-number" id="teacherCount">-</div>
                    <div class="stat-label">Docentes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="studentCount">-</div>
                    <div class="stat-label">Estudiantes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="classroomCount">-</div>
                    <div class="stat-label">Aulas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="subjectCount">-</div>
                    <div class="stat-label">Materias</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sectionCount">-</div>
                    <div class="stat-label">Secciones</div>
                </div>
            </div>

            <!-- Import/Export Sections -->
            <div class="section-grid">
                <!-- Teachers Section -->
                <div class="excel-section">
                    <div class="section-title">
                        <i class="fas fa-chalkboard-teacher section-icon"></i>
                        Docentes
                    </div>

                    <div class="upload-area" id="teachersUploadArea">
                        <input type="file" id="teachersFileInput" class="file-input" accept=".xlsx,.xls">
                        <div class="upload-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="upload-text">
                            <strong>Arrastra tu archivo aquí</strong><br>
                            o haz clic para seleccionar
                        </div>
                        <small class="text-muted">Formatos: .xlsx, .xls (Máx. 10MB)</small>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-excel" onclick="downloadTemplate('teachers')">
                            <i class="fas fa-download"></i> Plantilla
                        </button>
                        <button class="btn-excel btn-excel-secondary" onclick="exportTeachers()">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <button class="btn-excel" id="uploadTeachersBtn" onclick="uploadTeachers()" disabled>
                            <i class="fas fa-upload"></i> Importar
                        </button>
                    </div>

                    <div class="progress-section" id="teachersProgress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-section" id="teachersResult"></div>
                </div>

                <!-- Students Section -->
                <div class="excel-section">
                    <div class="section-title">
                        <i class="fas fa-user-graduate section-icon"></i>
                        Estudiantes
                    </div>

                    <div class="upload-area" id="studentsUploadArea">
                        <input type="file" id="studentsFileInput" class="file-input" accept=".xlsx,.xls">
                        <div class="upload-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="upload-text">
                            <strong>Arrastra tu archivo aquí</strong><br>
                            o haz clic para seleccionar
                        </div>
                        <small class="text-muted">Formatos: .xlsx, .xls (Máx. 10MB)</small>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-excel" onclick="downloadTemplate('students')">
                            <i class="fas fa-download"></i> Plantilla
                        </button>
                        <button class="btn-excel btn-excel-secondary" onclick="exportStudents()">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <button class="btn-excel" id="uploadStudentsBtn" onclick="uploadStudents()" disabled>
                            <i class="fas fa-upload"></i> Importar
                        </button>
                    </div>

                    <div class="progress-section" id="studentsProgress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-section" id="studentsResult"></div>
                </div>

                <!-- Classrooms Section -->
                <div class="excel-section">
                    <div class="section-title">
                        <i class="fas fa-building section-icon"></i>
                        Aulas
                    </div>

                    <div class="upload-area" id="classroomsUploadArea">
                        <input type="file" id="classroomsFileInput" class="file-input" accept=".xlsx,.xls">
                        <div class="upload-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="upload-text">
                            <strong>Arrastra tu archivo aquí</strong><br>
                            o haz clic para seleccionar
                        </div>
                        <small class="text-muted">Formatos: .xlsx, .xls (Máx. 10MB)</small>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-excel" onclick="downloadTemplate('classrooms')">
                            <i class="fas fa-download"></i> Plantilla
                        </button>
                        <button class="btn-excel btn-excel-secondary" onclick="exportClassrooms()">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <button class="btn-excel" id="uploadClassroomsBtn" onclick="uploadClassrooms()" disabled>
                            <i class="fas fa-upload"></i> Importar
                        </button>
                    </div>

                    <div class="progress-section" id="classroomsProgress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-section" id="classroomsResult"></div>
                </div>

                <!-- Schedule Export Section -->
                <div class="excel-section">
                    <div class="section-title">
                        <i class="fas fa-calendar-alt section-icon"></i>
                        Horarios
                    </div>

                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div class="upload-icon" style="margin-bottom: var(--spacing-md);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <p class="text-muted">Exporta el horario completo en formato Excel compatible con el sistema venezolano</p>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-excel" onclick="exportSchedule()">
                            <i class="fas fa-file-export"></i> Exportar Horario
                        </button>
                        <button class="btn-excel btn-excel-secondary" onclick="exportScheduleAll()">
                            <i class="fas fa-download"></i> Todos los Períodos
                        </button>
                    </div>

                    <div class="progress-section" id="scheduleProgress">
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-section" id="scheduleResult"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('bischeduler-theme');
            const theme = savedTheme || 'light';
            document.documentElement.setAttribute('data-theme', theme);

            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
                text.textContent = 'Modo Claro';
            }
        }

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('bischeduler-theme', newTheme);

            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (newTheme === 'dark') {
                icon.className = 'fas fa-sun';
                text.textContent = 'Modo Claro';
            } else {
                icon.className = 'fas fa-moon';
                text.textContent = 'Modo Oscuro';
            }
        });

        // File upload handlers
        function setupFileHandlers() {
            const sections = ['teachers', 'students', 'classrooms'];

            sections.forEach(section => {
                const uploadArea = document.getElementById(`${section}UploadArea`);
                const fileInput = document.getElementById(`${section}FileInput`);
                const uploadBtn = document.getElementById(`upload${section.charAt(0).toUpperCase() + section.slice(1)}Btn`);

                // Drag and drop handlers
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        fileSelected(section);
                    }
                });

                // File input change handler
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        fileSelected(section);
                    }
                });
            });
        }

        function fileSelected(section) {
            const uploadBtn = document.getElementById(`upload${section.charAt(0).toUpperCase() + section.slice(1)}Btn`);
            const fileInput = document.getElementById(`${section}FileInput`);

            if (fileInput.files.length > 0) {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Importar ${fileInput.files[0].name}`;
            }
        }

        // Template download functions
        function downloadTemplate(type) {
            window.location.href = `/bischeduler/api/excel/templates/${type}`;
        }

        // Upload functions
        async function uploadTeachers() {
            await uploadFile('teachers', '/bischeduler/api/excel/upload-teachers');
        }

        async function uploadStudents() {
            await uploadFile('students', '/bischeduler/api/excel/upload-students');
        }

        async function uploadClassrooms() {
            await uploadFile('classrooms', '/bischeduler/api/excel/upload-classrooms');
        }

        async function uploadFile(section, endpoint) {
            const fileInput = document.getElementById(`${section}FileInput`);
            const progressSection = document.getElementById(`${section}Progress`);
            const resultSection = document.getElementById(`${section}Result`);
            const progressBar = progressSection.querySelector('.progress-bar');

            if (!fileInput.files.length) {
                alert('Por favor selecciona un archivo');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            // Show progress
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            progressBar.style.width = '10%';

            try {
                progressBar.style.width = '50%';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '90%';

                const result = await response.json();

                progressBar.style.width = '100%';

                setTimeout(() => {
                    progressSection.style.display = 'none';
                    showResult(section, result);
                    loadStatistics(); // Refresh stats
                }, 500);

            } catch (error) {
                progressSection.style.display = 'none';
                showResult(section, { success: false, error: error.message });
            }
        }

        // Export functions
        function exportTeachers() {
            window.location.href = '/bischeduler/api/excel/export-teachers';
        }

        function exportStudents() {
            // For future implementation
            alert('Exportación de estudiantes estará disponible próximamente');
        }

        function exportClassrooms() {
            // For future implementation
            alert('Exportación de aulas estará disponible próximamente');
        }

        function exportSchedule() {
            window.location.href = '/bischeduler/api/excel/export-schedule';
        }

        function exportScheduleAll() {
            window.location.href = '/bischeduler/api/excel/export-schedule?all=true';
        }

        // Result display
        function showResult(section, result) {
            const resultSection = document.getElementById(`${section}Result`);

            let html = '';
            if (result.success) {
                html = `
                    <div class="result-success">
                        <i class="fas fa-check-circle"></i> ${result.message}
                    </div>
                `;
                if (result.results && result.results.details) {
                    html += `
                        <div class="result-details">
                            ${result.results.details.join('\n')}
                        </div>
                    `;
                }
            } else {
                html = `
                    <div class="result-error">
                        <i class="fas fa-exclamation-triangle"></i> Error: ${result.error}
                    </div>
                `;
            }

            resultSection.innerHTML = html;
            resultSection.style.display = 'block';

            // Reset file input
            const fileInput = document.getElementById(`${section}FileInput`);
            const uploadBtn = document.getElementById(`upload${section.charAt(0).toUpperCase() + section.slice(1)}Btn`);
            fileInput.value = '';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Importar`;
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/bischeduler/api/excel/statistics');
                const data = await response.json();

                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('teacherCount').textContent = stats.teachers || 0;
                    document.getElementById('studentCount').textContent = stats.students || 0;
                    document.getElementById('classroomCount').textContent = stats.classrooms || 0;
                    document.getElementById('subjectCount').textContent = stats.subjects || 0;
                    document.getElementById('sectionCount').textContent = stats.sections || 0;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            setupFileHandlers();
            loadStatistics();
        });
    </script>
</body>
</html>