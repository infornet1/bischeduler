<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003366">
    <title>Portal del Profesor - BiScheduler [Fase 4: CRÍTICO]</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/bischeduler/static/css/styles.css">
    <link rel="stylesheet" href="/bischeduler/static/css/dark-mode.css">

    <style>
        .teacher-portal {
            min-height: 100vh;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: var(--spacing-lg);
        }

        .portal-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .portal-header {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
        }

        .teacher-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .teacher-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #003366, #ffcc00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: bold;
        }

        .portal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.2));
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-lg);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .stat-icon.workload { background: linear-gradient(135deg, #28a745, #20c997); }
        .stat-icon.preferences { background: linear-gradient(135deg, #007bff, #6f42c1); }
        .stat-icon.requests { background: linear-gradient(135deg, #fd7e14, #e83e8c); }
        .stat-icon.schedule { background: linear-gradient(135deg, #6f42c1, #e83e8c); }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary, #212529);
            margin-bottom: var(--spacing-sm);
        }

        .stat-label {
            color: var(--text-secondary, #6c757d);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }

        .stat-progress {
            height: 8px;
            background: var(--bg-tertiary, #e9ecef);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--spacing-sm);
        }

        .stat-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .stat-details {
            font-size: 0.85rem;
            color: var(--text-muted, #6c757d);
        }

        .portal-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .section-card {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.2));
        }

        .section-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color, #dee2e6);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .section-content {
            padding: var(--spacing-lg);
            max-height: 500px;
            overflow-y: auto;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: var(--border-color, #dee2e6);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .schedule-header {
            background: var(--primary-color, #003366);
            color: white;
            padding: var(--spacing-sm);
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
        }

        .schedule-time {
            background: var(--bg-secondary, #f8f9fa);
            padding: var(--spacing-sm);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary, #212529);
        }

        .schedule-cell {
            background: var(--card-bg, white);
            padding: var(--spacing-xs);
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--text-primary, #212529);
        }

        .schedule-cell.has-class {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.1), rgba(255, 204, 0, 0.1));
            border-left: 3px solid var(--primary-color, #003366);
        }

        .schedule-subject {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .schedule-section {
            color: var(--text-secondary, #6c757d);
        }

        .preferences-list {
            display: grid;
            gap: var(--spacing-md);
        }

        .preference-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-secondary, #f8f9fa);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color, #dee2e6);
        }

        .preference-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .preference-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .preference-badge.prefer { background: #d4edda; color: #155724; }
        .preference-badge.like { background: #cce7ff; color: #004085; }
        .preference-badge.neutral { background: #e2e3e5; color: #383d41; }
        .preference-badge.dislike { background: #fff3cd; color: #856404; }
        .preference-badge.avoid { background: #f8d7da; color: #721c24; }

        .btn-portal {
            background: var(--primary-color, #003366);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius);
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: var(--transition);
        }

        .btn-portal:hover {
            background: #004080;
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .teacher-portal {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        [data-theme="dark"] .stat-progress {
            background: #404040;
        }

        [data-theme="dark"] .schedule-header {
            background: #404040;
        }

        [data-theme="dark"] .schedule-time {
            background: #2d2d2d;
        }

        [data-theme="dark"] .schedule-cell.has-class {
            background: linear-gradient(135deg, rgba(109, 163, 208, 0.2), rgba(255, 204, 0, 0.1));
        }

        [data-theme="dark"] .preference-item {
            background: #404040;
            border-color: #555;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .portal-sections {
                grid-template-columns: 1fr;
            }

            .teacher-info {
                flex-direction: column;
                text-align: center;
            }

            .schedule-grid {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- User Bar (consistent with dashboard) -->
    <div class="user-bar">
        <div class="user-info">
            <span class="user-name" id="currentUserName">Professor</span>
            <span class="user-role">Portal del Profesor</span>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="user-dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle"></i>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <div class="dropdown-item-text">
                        <small class="text-muted">Portal del Profesor</small><br>
                        <span id="dropdownUserName">Cargando...</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="darkModeToggle">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                        <span id="darkModeText">Modo Oscuro</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/bischeduler/dashboard">
                        <i class="fas fa-home"></i> Panel Principal
                    </a>
                    <button class="dropdown-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="teacher-portal">
        <div class="portal-container">
            <!-- Portal Header -->
            <div class="portal-header">
                <div class="teacher-info">
                    <div class="teacher-avatar" id="teacherAvatar">
                        PR
                    </div>
                    <div>
                        <h1 class="mb-2" id="teacherName">Portal del Profesor</h1>
                        <p class="text-muted mb-1" id="teacherSpecialization">Cargando información...</p>
                        <p class="text-muted mb-0" id="teacherHours">Sistema de Gestión de Horarios K12</p>
                    </div>
                    <div class="ml-auto">
                        <button class="btn-portal" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i>
                            Actualizar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="portal-stats" id="portalStats">
                <!-- Workload Stats -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon workload">
                            <i class="fas fa-clock"></i>
                        </div>
                        <span>Carga de Trabajo</span>
                    </div>
                    <div class="stat-value" id="totalHours">--</div>
                    <div class="stat-label">Horas Semanales</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="workloadProgress" style="width: 0%"></div>
                    </div>
                    <div class="stat-details" id="workloadDetails">
                        -- clases • -- materias • -- secciones
                    </div>
                </div>

                <!-- Preference Satisfaction -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon preferences">
                            <i class="fas fa-heart"></i>
                        </div>
                        <span>Satisfacción de Preferencias</span>
                    </div>
                    <div class="stat-value" id="satisfactionScore">--%</div>
                    <div class="stat-label">Puntuación General</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="satisfactionProgress" style="width: 0%"></div>
                    </div>
                    <div class="stat-details" id="satisfactionDetails">
                        Tiempo: --% • Día: --% • Materia: --%
                    </div>
                </div>

                <!-- Change Requests -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon requests">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <span>Solicitudes de Cambio</span>
                    </div>
                    <div class="stat-value" id="pendingRequests">--</div>
                    <div class="stat-label">Pendientes</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="requestsProgress" style="width: 0%"></div>
                    </div>
                    <div class="stat-details" id="requestsDetails">
                        Total: -- • Aprobadas: -- (--%)
                    </div>
                </div>

                <!-- Schedule Balance -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon schedule">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <span>Balance de Horario</span>
                    </div>
                    <div class="stat-value" id="balanceScore">--%</div>
                    <div class="stat-label">Distribución Semanal</div>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" id="balanceProgress" style="width: 0%"></div>
                    </div>
                    <div class="stat-details" id="balanceDetails">
                        Máx consecutivas: -- • Períodos libres: --
                    </div>
                </div>
            </div>

            <!-- Main Portal Sections -->
            <div class="portal-sections">
                <!-- Current Schedule -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-calendar-week text-primary"></i>
                        <h3 class="mb-0">Horario Actual</h3>
                        <div class="ml-auto">
                            <button class="btn btn-sm btn-outline-primary" onclick="changeWeek(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="mx-2" id="currentWeek">Semana Actual</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="changeWeek(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="schedule-grid" id="scheduleGrid">
                            <!-- Schedule will be loaded here -->
                            <div class="schedule-header">Hora</div>
                            <div class="schedule-header">Lunes</div>
                            <div class="schedule-header">Martes</div>
                            <div class="schedule-header">Miércoles</div>
                            <div class="schedule-header">Jueves</div>
                            <div class="schedule-header">Viernes</div>

                            <!-- Loading placeholder -->
                            <div class="schedule-time">...</div>
                            <div class="schedule-cell">Cargando horario...</div>
                            <div class="schedule-cell"></div>
                            <div class="schedule-cell"></div>
                            <div class="schedule-cell"></div>
                            <div class="schedule-cell"></div>
                        </div>
                    </div>
                </div>

                <!-- Teacher Preferences -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-star text-warning"></i>
                        <h3 class="mb-0">Mis Preferencias</h3>
                        <div class="ml-auto">
                            <button class="btn btn-sm btn-primary" onclick="openPreferencesModal()">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="preferences-list" id="preferencesList">
                            <!-- Preferences will be loaded here -->
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-sync fa-spin"></i>
                                <p class="mt-2">Cargando preferencias...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="d-flex justify-content-center gap-3 mb-4">
                <a href="#" class="btn-portal" onclick="openPreferencesModal()">
                    <i class="fas fa-star"></i>
                    Gestionar Preferencias
                </a>
                <a href="#" class="btn-portal" onclick="requestScheduleChange()">
                    <i class="fas fa-exchange-alt"></i>
                    Solicitar Cambio
                </a>
                <a href="/bischeduler/dashboard" class="btn-portal">
                    <i class="fas fa-home"></i>
                    Volver al Panel
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Teacher Portal JavaScript
        class TeacherPortal {
            constructor() {
                this.currentTeacherId = 1; // Demo teacher ID
                this.currentWeekOffset = 0;
                this.init();
            }

            init() {
                this.initializeTheme();
                this.loadTeacherData();
                this.loadDashboardStats();
                this.loadSchedule();
                this.loadPreferences();
                this.setupEventListeners();
            }

            initializeTheme() {
                const savedTheme = localStorage.getItem('bischeduler-theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
                this.setTheme(initialTheme);

                // Setup dark mode toggle
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                localStorage.setItem('bischeduler-theme', newTheme);
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);

                const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                if (metaThemeColor) {
                    metaThemeColor.setAttribute('content', theme === 'dark' ? '#1a1a1a' : '#003366');
                }

                // Update toggle icon and text
                const icon = document.getElementById('darkModeIcon');
                const text = document.getElementById('darkModeText');
                if (icon && text) {
                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Modo Claro';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Modo Oscuro';
                    }
                }
            }

            setupEventListeners() {
                // Global refresh button
                window.refreshDashboard = () => {
                    this.loadDashboardStats();
                    this.loadSchedule();
                    this.loadPreferences();
                };

                // Week navigation
                window.changeWeek = (offset) => {
                    this.currentWeekOffset += offset;
                    this.loadSchedule();
                    document.getElementById('currentWeek').textContent =
                        this.currentWeekOffset === 0 ? 'Semana Actual' :
                        this.currentWeekOffset > 0 ? `+${this.currentWeekOffset} semanas` :
                        `${this.currentWeekOffset} semanas`;
                };

                // Modal functions
                window.openPreferencesModal = () => {
                    alert('Modal de preferencias - En desarrollo (Phase 6)');
                };

                window.requestScheduleChange = () => {
                    alert('Solicitud de cambio - En desarrollo (Phase 6)');
                };

                // Logout function
                window.handleLogout = () => {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_info');
                    window.location.href = '/bischeduler/login';
                };
            }

            async loadTeacherData() {
                try {
                    // Demo data for now
                    const teacherData = {
                        name: 'MARIA NIETO',
                        specialization: 'Especialista en Bachillerato',
                        maxHours: 40
                    };

                    document.getElementById('teacherName').textContent = teacherData.name;
                    document.getElementById('teacherSpecialization').textContent = teacherData.specialization;
                    document.getElementById('teacherHours').textContent = `Carga máxima: ${teacherData.maxHours} horas semanales`;
                    document.getElementById('currentUserName').textContent = teacherData.name;
                    document.getElementById('dropdownUserName').textContent = teacherData.name;

                    // Update avatar with initials
                    const initials = teacherData.name.split(' ').map(n => n[0]).join('').substr(0, 2);
                    document.getElementById('teacherAvatar').textContent = initials;

                } catch (error) {
                    console.error('Error loading teacher data:', error);
                }
            }

            async loadDashboardStats() {
                try {
                    // Demo stats data
                    const stats = {
                        workload: {
                            total_weekly_hours: 28,
                            total_classes: 15,
                            total_subjects: 3,
                            total_sections: 5,
                            workload_balance_score: 85.5,
                            consecutive_classes_max: 3,
                            free_periods_per_week: 8
                        },
                        preferences: {
                            overall_satisfaction: 78.5,
                            time_satisfaction: 82.0,
                            day_satisfaction: 75.0,
                            subject_satisfaction: 80.0,
                            classroom_satisfaction: 76.0
                        },
                        change_requests: {
                            total: 5,
                            approved: 4,
                            pending: 1,
                            approval_rate: 80.0
                        }
                    };

                    this.updateStatsDisplay(stats);

                } catch (error) {
                    console.error('Error loading dashboard stats:', error);
                }
            }

            updateStatsDisplay(stats) {
                // Workload stats
                document.getElementById('totalHours').textContent = `${stats.workload.total_weekly_hours}`;
                document.getElementById('workloadProgress').style.width = `${(stats.workload.total_weekly_hours / 40) * 100}%`;
                document.getElementById('workloadDetails').textContent =
                    `${stats.workload.total_classes} clases • ${stats.workload.total_subjects} materias • ${stats.workload.total_sections} secciones`;

                // Preference satisfaction
                document.getElementById('satisfactionScore').textContent = `${stats.preferences.overall_satisfaction}%`;
                document.getElementById('satisfactionProgress').style.width = `${stats.preferences.overall_satisfaction}%`;
                document.getElementById('satisfactionDetails').textContent =
                    `Tiempo: ${stats.preferences.time_satisfaction}% • Día: ${stats.preferences.day_satisfaction}% • Materia: ${stats.preferences.subject_satisfaction}%`;

                // Change requests
                document.getElementById('pendingRequests').textContent = `${stats.change_requests.pending}`;
                document.getElementById('requestsProgress').style.width = `${stats.change_requests.approval_rate}%`;
                document.getElementById('requestsDetails').textContent =
                    `Total: ${stats.change_requests.total} • Aprobadas: ${stats.change_requests.approved} (${stats.change_requests.approval_rate}%)`;

                // Balance score
                document.getElementById('balanceScore').textContent = `${stats.workload.workload_balance_score}%`;
                document.getElementById('balanceProgress').style.width = `${stats.workload.workload_balance_score}%`;
                document.getElementById('balanceDetails').textContent =
                    `Máx consecutivas: ${stats.workload.consecutive_classes_max} • Períodos libres: ${stats.workload.free_periods_per_week}`;
            }

            async loadSchedule() {
                try {
                    // Demo schedule data
                    const scheduleData = {
                        schedule_grid: {
                            1: {
                                period_info: { name: 'P1', start_time: '07:00', end_time: '07:40', is_break: false },
                                assignments: {
                                    lunes: { subject: 'MATEMÁTICAS', section: '3er año A', classroom: 'Aula 3' },
                                    martes: { subject: 'MATEMÁTICAS', section: '3er año B', classroom: 'Aula 3' },
                                    miercoles: null,
                                    jueves: { subject: 'MATEMÁTICAS', section: '3er año A', classroom: 'Aula 3' },
                                    viernes: { subject: 'MATEMÁTICAS', section: '3er año C', classroom: 'Aula 5' }
                                }
                            },
                            2: {
                                period_info: { name: 'P2', start_time: '07:40', end_time: '08:20', is_break: false },
                                assignments: {
                                    lunes: { subject: 'FÍSICA', section: '4to año A', classroom: 'Lab Física' },
                                    martes: null,
                                    miercoles: { subject: 'FÍSICA', section: '4to año B', classroom: 'Lab Física' },
                                    jueves: null,
                                    viernes: { subject: 'MATEMÁTICAS', section: '3er año B', classroom: 'Aula 3' }
                                }
                            }
                        }
                    };

                    this.renderScheduleGrid(scheduleData.schedule_grid);

                } catch (error) {
                    console.error('Error loading schedule:', error);
                }
            }

            renderScheduleGrid(scheduleGrid) {
                const grid = document.getElementById('scheduleGrid');

                // Clear existing content except headers
                const headers = grid.querySelectorAll('.schedule-header');
                grid.innerHTML = '';
                headers.forEach(header => grid.appendChild(header));

                const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];

                Object.entries(scheduleGrid).forEach(([periodId, periodData]) => {
                    // Time cell
                    const timeCell = document.createElement('div');
                    timeCell.className = 'schedule-time';
                    timeCell.innerHTML = `
                        <strong>${periodData.period_info.name}</strong><br>
                        <small>${periodData.period_info.start_time}-${periodData.period_info.end_time}</small>
                    `;
                    grid.appendChild(timeCell);

                    // Day cells
                    days.forEach(day => {
                        const cell = document.createElement('div');
                        cell.className = 'schedule-cell';

                        const assignment = periodData.assignments[day];
                        if (assignment) {
                            cell.classList.add('has-class');
                            cell.innerHTML = `
                                <div class="schedule-subject">${assignment.subject}</div>
                                <div class="schedule-section">${assignment.section}</div>
                                <small>${assignment.classroom}</small>
                            `;
                        }

                        grid.appendChild(cell);
                    });
                });
            }

            async loadPreferences() {
                try {
                    // Demo preferences data
                    const preferences = {
                        time_slots: [
                            { level: 'prefer', time_period: { name: 'P1', start_time: '07:00', end_time: '07:40' }, reason: 'Mejor concentración en la mañana' },
                            { level: 'avoid', time_period: { name: 'P7', start_time: '11:00', end_time: '11:40' }, reason: 'Hora de almuerzo preferida' }
                        ],
                        days: [
                            { level: 'prefer', day: 'lunes', reason: 'Inicio productivo de semana' },
                            { level: 'dislike', day: 'viernes', reason: 'Estudiantes menos concentrados' }
                        ],
                        subjects: [
                            { level: 'prefer', subject: { name: 'MATEMÁTICAS' }, reason: 'Especialización principal' },
                            { level: 'like', subject: { name: 'FÍSICA' }, reason: 'Experiencia previa' }
                        ]
                    };

                    this.renderPreferences(preferences);

                } catch (error) {
                    console.error('Error loading preferences:', error);
                }
            }

            renderPreferences(preferences) {
                const container = document.getElementById('preferencesList');
                container.innerHTML = '';

                const allPrefs = [
                    ...preferences.time_slots.map(p => ({ ...p, type: 'Horario', target: p.time_period.name })),
                    ...preferences.days.map(p => ({ ...p, type: 'Día', target: this.getDayLabel(p.day) })),
                    ...preferences.subjects.map(p => ({ ...p, type: 'Materia', target: p.subject.name }))
                ];

                if (allPrefs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-star"></i>
                            <p class="mt-2">No hay preferencias configuradas</p>
                            <button class="btn btn-primary btn-sm" onclick="openPreferencesModal()">
                                Agregar Preferencia
                            </button>
                        </div>
                    `;
                    return;
                }

                allPrefs.forEach(pref => {
                    const item = document.createElement('div');
                    item.className = 'preference-item';
                    item.innerHTML = `
                        <div class="preference-info">
                            <span class="preference-badge ${pref.level}">${this.getPreferenceLabel(pref.level)}</span>
                            <div>
                                <strong>${pref.type}: ${pref.target}</strong>
                                ${pref.reason ? `<br><small class="text-muted">${pref.reason}</small>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editPreference(${pref.id || 0})">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                    container.appendChild(item);
                });
            }

            getDayLabel(day) {
                const labels = {
                    'lunes': 'Lunes',
                    'martes': 'Martes',
                    'miercoles': 'Miércoles',
                    'jueves': 'Jueves',
                    'viernes': 'Viernes'
                };
                return labels[day] || day;
            }

            getPreferenceLabel(level) {
                const labels = {
                    'avoid': 'Evitar',
                    'dislike': 'No Prefiero',
                    'neutral': 'Neutral',
                    'like': 'Me Gusta',
                    'prefer': 'Prefiero'
                };
                return labels[level] || level;
            }
        }

        // Initialize teacher portal when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new TeacherPortal();
        });
    </script>

    <!-- PHASE 4 CRITICAL: Teacher Preference Submission Modal -->
    <div class="modal fade" id="preferencesModal" tabindex="-1" role="dialog" aria-labelledby="preferencesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-color, #003366); color: white;">
                    <h5 class="modal-title" id="preferencesModalLabel">
                        <i class="fas fa-star"></i> Configurar Preferencias de Horario
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                    <!-- Preference Scoring Algorithm Info -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Sistema de Puntuación:</strong>
                        Horarios (40%) • Días (30%) • Materias (20%) • Aulas (10%)
                    </div>

                    <!-- Preference Forms -->
                    <div class="preference-forms">
                        <!-- Time Preferences -->
                        <div class="preference-section">
                            <h6><i class="fas fa-clock"></i> Preferencias de Horario (40% peso)</h6>
                            <div class="time-preferences-grid">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Período de Preferencia:</label>
                                        <select class="form-control" id="timePreferenceSelect">
                                            <option value="">Seleccionar período...</option>
                                            <option value="1">7:00 - 7:40 (Período 1)</option>
                                            <option value="2">7:40 - 8:20 (Período 2)</option>
                                            <option value="3">8:20 - 9:00 (Período 3)</option>
                                            <option value="4">9:00 - 9:40 (Período 4)</option>
                                            <option value="6">10:00 - 10:40 (Período 6)</option>
                                            <option value="7">10:40 - 11:20 (Período 7)</option>
                                            <option value="8">11:20 - 12:00 (Período 8)</option>
                                            <option value="9">12:00 - 12:40 (Período 9)</option>
                                            <option value="10">1:00 - 1:40 (Período 10)</option>
                                            <option value="11">1:40 - 2:20 (Período 11)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Nivel de Preferencia:</label>
                                        <select class="form-control" id="timePreferenceLevel">
                                            <option value="prefer">Prefiero (10 pts)</option>
                                            <option value="like">Me Gusta (5 pts)</option>
                                            <option value="neutral">Neutral (0 pts)</option>
                                            <option value="dislike">No Prefiero (-5 pts)</option>
                                            <option value="avoid">Evitar (-10 pts)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label>&nbsp;</label>
                                        <button class="btn btn-primary btn-block" onclick="addTimePreference()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="current-preferences mt-3" id="timePreferencesList">
                                    <!-- Current time preferences will be shown here -->
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Day Preferences -->
                        <div class="preference-section">
                            <h6><i class="fas fa-calendar-day"></i> Preferencias de Días (30% peso)</h6>
                            <div class="day-preferences-grid">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Día de la Semana:</label>
                                        <select class="form-control" id="dayPreferenceSelect">
                                            <option value="">Seleccionar día...</option>
                                            <option value="monday">Lunes</option>
                                            <option value="tuesday">Martes</option>
                                            <option value="wednesday">Miércoles</option>
                                            <option value="thursday">Jueves</option>
                                            <option value="friday">Viernes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Nivel de Preferencia:</label>
                                        <select class="form-control" id="dayPreferenceLevel">
                                            <option value="prefer">Prefiero (10 pts)</option>
                                            <option value="like">Me Gusta (5 pts)</option>
                                            <option value="neutral">Neutral (0 pts)</option>
                                            <option value="dislike">No Prefiero (-5 pts)</option>
                                            <option value="avoid">Evitar (-10 pts)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label>&nbsp;</label>
                                        <button class="btn btn-primary btn-block" onclick="addDayPreference()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="current-preferences mt-3" id="dayPreferencesList">
                                    <!-- Current day preferences will be shown here -->
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Subject Preferences -->
                        <div class="preference-section">
                            <h6><i class="fas fa-book"></i> Preferencias de Materias (20% peso)</h6>
                            <div class="subject-preferences-grid">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Materia:</label>
                                        <select class="form-control" id="subjectPreferenceSelect">
                                            <option value="">Seleccionar materia...</option>
                                            <option value="1">CASTELLANO Y LITERATURA</option>
                                            <option value="2">INGLÉS</option>
                                            <option value="3">MATEMÁTICAS</option>
                                            <option value="4">FÍSICA</option>
                                            <option value="5">QUÍMICA</option>
                                            <option value="6">BIOLOGÍA</option>
                                            <option value="7">GHC PARA LA SOBERANIA NACIONAL</option>
                                            <option value="8">EDUCACIÓN FÍSICA</option>
                                            <option value="9">ORIENTACIÓN VOCACIONAL</option>
                                            <option value="10">LOGICA MATEMÁTICA</option>
                                            <option value="11">ARTE Y PATRIMONIO</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Nivel de Preferencia:</label>
                                        <select class="form-control" id="subjectPreferenceLevel">
                                            <option value="prefer">Prefiero (10 pts)</option>
                                            <option value="like">Me Gusta (5 pts)</option>
                                            <option value="neutral">Neutral (0 pts)</option>
                                            <option value="dislike">No Prefiero (-5 pts)</option>
                                            <option value="avoid">Evitar (-10 pts)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label>&nbsp;</label>
                                        <button class="btn btn-primary btn-block" onclick="addSubjectPreference()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="current-preferences mt-3" id="subjectPreferencesList">
                                    <!-- Current subject preferences will be shown here -->
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Classroom Preferences -->
                        <div class="preference-section">
                            <h6><i class="fas fa-door-open"></i> Preferencias de Aulas (10% peso)</h6>
                            <div class="classroom-preferences-grid">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Aula:</label>
                                        <select class="form-control" id="classroomPreferenceSelect">
                                            <option value="">Seleccionar aula...</option>
                                            <option value="1">Aula 1</option>
                                            <option value="2">Aula 2</option>
                                            <option value="3">Aula 3</option>
                                            <option value="4">Lab Física</option>
                                            <option value="5">Lab Química</option>
                                            <option value="6">Cancha 1</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Nivel de Preferencia:</label>
                                        <select class="form-control" id="classroomPreferenceLevel">
                                            <option value="prefer">Prefiero (10 pts)</option>
                                            <option value="like">Me Gusta (5 pts)</option>
                                            <option value="neutral">Neutral (0 pts)</option>
                                            <option value="dislike">No Prefiero (-5 pts)</option>
                                            <option value="avoid">Evitar (-10 pts)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label>&nbsp;</label>
                                        <button class="btn btn-primary btn-block" onclick="addClassroomPreference()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="current-preferences mt-3" id="classroomPreferencesList">
                                    <!-- Current classroom preferences will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- Reason Input -->
                        <div class="preference-section">
                            <label for="preferenceReason">Justificación (Opcional):</label>
                            <textarea class="form-control" id="preferenceReason" rows="2"
                                placeholder="Explique brevemente el motivo de estas preferencias..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-calculator"></i>
                                Puntuación estimada: <span id="estimatedScore">0</span> puntos
                            </small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="savePreferences()">
                                <i class="fas fa-save"></i> Guardar Preferencias
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 4 Critical: Preference Management JavaScript -->
    <script>
        // Global preference storage
        let currentPreferences = {
            time: [],
            day: [],
            subject: [],
            classroom: []
        };

        // Phase 4 Critical: Open preferences modal
        window.openPreferencesModal = () => {
            loadCurrentPreferences();
            $('#preferencesModal').modal('show');
        };

        // Load existing preferences
        function loadCurrentPreferences() {
            // TODO: Load from API
            renderAllPreferences();
        }

        // Add time preference
        window.addTimePreference = () => {
            const select = document.getElementById('timePreferenceSelect');
            const level = document.getElementById('timePreferenceLevel');
            const reason = document.getElementById('preferenceReason');

            if (!select.value) {
                alert('Por favor seleccione un período');
                return;
            }

            const preference = {
                id: Date.now(),
                time_period_id: select.value,
                time_display: select.options[select.selectedIndex].text,
                level: level.value,
                level_display: level.options[level.selectedIndex].text,
                reason: reason.value,
                type: 'time'
            };

            currentPreferences.time.push(preference);
            renderTimePreferences();
            calculateEstimatedScore();

            // Reset form
            select.value = '';
            reason.value = '';
        };

        // Add day preference
        window.addDayPreference = () => {
            const select = document.getElementById('dayPreferenceSelect');
            const level = document.getElementById('dayPreferenceLevel');
            const reason = document.getElementById('preferenceReason');

            if (!select.value) {
                alert('Por favor seleccione un día');
                return;
            }

            const preference = {
                id: Date.now(),
                day: select.value,
                day_display: select.options[select.selectedIndex].text,
                level: level.value,
                level_display: level.options[level.selectedIndex].text,
                reason: reason.value,
                type: 'day'
            };

            currentPreferences.day.push(preference);
            renderDayPreferences();
            calculateEstimatedScore();

            select.value = '';
            reason.value = '';
        };

        // Add subject preference
        window.addSubjectPreference = () => {
            const select = document.getElementById('subjectPreferenceSelect');
            const level = document.getElementById('subjectPreferenceLevel');
            const reason = document.getElementById('preferenceReason');

            if (!select.value) {
                alert('Por favor seleccione una materia');
                return;
            }

            const preference = {
                id: Date.now(),
                subject_id: select.value,
                subject_display: select.options[select.selectedIndex].text,
                level: level.value,
                level_display: level.options[level.selectedIndex].text,
                reason: reason.value,
                type: 'subject'
            };

            currentPreferences.subject.push(preference);
            renderSubjectPreferences();
            calculateEstimatedScore();

            select.value = '';
            reason.value = '';
        };

        // Add classroom preference
        window.addClassroomPreference = () => {
            const select = document.getElementById('classroomPreferenceSelect');
            const level = document.getElementById('classroomPreferenceLevel');
            const reason = document.getElementById('preferenceReason');

            if (!select.value) {
                alert('Por favor seleccione un aula');
                return;
            }

            const preference = {
                id: Date.now(),
                classroom_id: select.value,
                classroom_display: select.options[select.selectedIndex].text,
                level: level.value,
                level_display: level.options[level.selectedIndex].text,
                reason: reason.value,
                type: 'classroom'
            };

            currentPreferences.classroom.push(preference);
            renderClassroomPreferences();
            calculateEstimatedScore();

            select.value = '';
            reason.value = '';
        };

        // Render preference lists
        function renderTimePreferences() {
            const container = document.getElementById('timePreferencesList');
            renderPreferenceList(container, currentPreferences.time, 'time');
        }

        function renderDayPreferences() {
            const container = document.getElementById('dayPreferencesList');
            renderPreferenceList(container, currentPreferences.day, 'day');
        }

        function renderSubjectPreferences() {
            const container = document.getElementById('subjectPreferencesList');
            renderPreferenceList(container, currentPreferences.subject, 'subject');
        }

        function renderClassroomPreferences() {
            const container = document.getElementById('classroomPreferencesList');
            renderPreferenceList(container, currentPreferences.classroom, 'classroom');
        }

        function renderAllPreferences() {
            renderTimePreferences();
            renderDayPreferences();
            renderSubjectPreferences();
            renderClassroomPreferences();
        }

        function renderPreferenceList(container, preferences, type) {
            container.innerHTML = '';
            preferences.forEach(pref => {
                const item = document.createElement('div');
                item.className = 'alert alert-secondary d-flex justify-content-between align-items-center mb-2';
                item.innerHTML = `
                    <div>
                        <span class="badge badge-${getPreferenceBadgeClass(pref.level)}">${pref.level_display}</span>
                        <strong>${getPreferenceDisplay(pref)}</strong>
                        ${pref.reason ? `<br><small class="text-muted">${pref.reason}</small>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removePreference('${type}', ${pref.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        function getPreferenceDisplay(pref) {
            switch(pref.type) {
                case 'time': return pref.time_display;
                case 'day': return pref.day_display;
                case 'subject': return pref.subject_display;
                case 'classroom': return pref.classroom_display;
                default: return 'Desconocido';
            }
        }

        function getPreferenceBadgeClass(level) {
            switch(level) {
                case 'prefer': return 'success';
                case 'like': return 'primary';
                case 'neutral': return 'secondary';
                case 'dislike': return 'warning';
                case 'avoid': return 'danger';
                default: return 'secondary';
            }
        }

        // Remove preference
        window.removePreference = (type, id) => {
            currentPreferences[type] = currentPreferences[type].filter(p => p.id !== id);
            renderAllPreferences();
            calculateEstimatedScore();
        };

        // Phase 4 Critical: Calculate estimated satisfaction score
        function calculateEstimatedScore() {
            let score = 0;
            const weights = { time: 0.40, day: 0.30, subject: 0.20, classroom: 0.10 };

            Object.keys(currentPreferences).forEach(type => {
                const prefs = currentPreferences[type];
                let typeScore = 0;
                prefs.forEach(pref => {
                    switch(pref.level) {
                        case 'prefer': typeScore += 10; break;
                        case 'like': typeScore += 5; break;
                        case 'neutral': typeScore += 0; break;
                        case 'dislike': typeScore -= 5; break;
                        case 'avoid': typeScore -= 10; break;
                    }
                });
                score += typeScore * weights[type];
            });

            document.getElementById('estimatedScore').textContent = Math.round(score);
        }

        // Phase 4 Critical: Save preferences
        window.savePreferences = async () => {
            try {
                // Prepare data for API
                const preferencesData = {
                    time_preferences: currentPreferences.time,
                    day_preferences: currentPreferences.day,
                    subject_preferences: currentPreferences.subject,
                    classroom_preferences: currentPreferences.classroom,
                    academic_year: '2025-2026'
                };

                // TODO: Send to API
                console.log('Saving preferences:', preferencesData);

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));

                alert('Preferencias guardadas exitosamente');
                $('#preferencesModal').modal('hide');

                // Refresh teacher portal data
                if (window.teacherPortal) {
                    window.teacherPortal.loadDashboardStats();
                    window.teacherPortal.loadPreferences();
                }

            } catch (error) {
                console.error('Error saving preferences:', error);
                alert('Error al guardar preferencias. Intente nuevamente.');
            }
        };

        // Phase 4 Critical: Edit existing preference
        window.editPreference = (id) => {
            alert('Funcionalidad de edición estará disponible próximamente');
        };
    </script>
</body>
</html>