<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003366">
    <title>Calendario de Ex√°menes - BiScheduler</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/bischeduler/static/css/styles.css">
    <link rel="stylesheet" href="/bischeduler/static/css/dark-mode.css">

    <style>
        .exam-calendar {
            min-height: 100vh;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: var(--spacing-lg);
        }

        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .calendar-header {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .calendar-navigation {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-button {
            background: var(--primary-color, #003366);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-button:hover {
            background: #004080;
            transform: scale(1.1);
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary, #212529);
            min-width: 200px;
            text-align: center;
        }

        .exam-filters {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: var(--border-radius);
            background: var(--card-bg, white);
            color: var(--text-primary, #212529);
            font-size: 0.9rem;
        }

        .calendar-grid {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar-header-row {
            background: var(--primary-color, #003366);
            color: white;
        }

        .calendar-header-cell {
            padding: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-day {
            height: 120px;
            vertical-align: top;
            border: 1px solid var(--border-color, #dee2e6);
            padding: var(--spacing-xs);
            position: relative;
            background: var(--card-bg, white);
            color: var(--text-primary, #212529);
        }

        .calendar-day.other-month {
            background: var(--bg-tertiary, #f8f9fa);
            color: var(--text-muted, #6c757d);
        }

        .calendar-day.today {
            background: rgba(0, 51, 102, 0.1);
            border-color: var(--primary-color, #003366);
            border-width: 2px;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .exam-event {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            margin-bottom: 2px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .exam-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .exam-event.parcial { background: linear-gradient(135deg, #28a745, #20c997); }
        .exam-event.final { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .exam-event.recuperacion { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .exam-event.extraordinario { background: linear-gradient(135deg, #6f42c1, #e83e8c); }

        .exam-details-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--card-bg, white);
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
            padding: var(--spacing-xl);
        }

        .exam-details-sidebar.open {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color, #dee2e6);
        }

        .close-sidebar {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary, #6c757d);
            cursor: pointer;
            padding: 0;
            margin-left: auto;
        }

        .exam-info-section {
            margin-bottom: var(--spacing-lg);
        }

        .section-title {
            font-weight: 600;
            color: var(--primary-color, #003366);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color, #dee2e6);
        }

        .info-label {
            font-weight: 500;
            color: var(--text-secondary, #6c757d);
        }

        .info-value {
            color: var(--text-primary, #212529);
            font-weight: 500;
        }

        .supervisor-card {
            background: var(--bg-secondary, #f8f9fa);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid var(--primary-color, #003366);
        }

        .supervisor-name {
            font-weight: 600;
            color: var(--text-primary, #212529);
        }

        .supervisor-role {
            font-size: 0.8rem;
            color: var(--text-secondary, #6c757d);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .supervisor-details {
            font-size: 0.85rem;
            color: var(--text-muted, #6c757d);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .btn-exam {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn-primary-exam {
            background: var(--primary-color, #003366);
            color: white;
        }

        .btn-primary-exam:hover {
            background: #004080;
            color: white;
            text-decoration: none;
        }

        .btn-secondary-exam {
            background: var(--bg-secondary, #6c757d);
            color: white;
        }

        .btn-secondary-exam:hover {
            background: #545b62;
            color: white;
            text-decoration: none;
        }

        .calendar-legend {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary, #212529);
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color, #003366);
            margin-bottom: var(--spacing-sm);
        }

        .stat-label {
            color: var(--text-secondary, #6c757d);
            font-size: 0.9rem;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .exam-calendar {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        [data-theme="dark"] .calendar-day {
            border-color: #404040;
        }

        [data-theme="dark"] .calendar-day.other-month {
            background: #2d2d2d;
        }

        [data-theme="dark"] .supervisor-card {
            background: #404040;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .calendar-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .calendar-navigation {
                justify-content: center;
            }

            .exam-filters {
                justify-content: center;
            }

            .exam-details-sidebar {
                width: 100%;
                right: -100%;
            }

            .calendar-header-cell,
            .calendar-day {
                padding: var(--spacing-xs);
                font-size: 0.8rem;
            }

            .calendar-day {
                height: 100px;
            }

            .exam-event {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- User Bar (consistent with dashboard) -->
    <div class="user-bar">
        <div class="user-info">
            <span class="user-name" id="currentUserName">Administrador</span>
            <span class="user-role">Calendario de Ex√°menes</span>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="user-dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user-circle"></i>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <div class="dropdown-item-text">
                        <small class="text-muted">Sistema de Ex√°menes</small><br>
                        <span id="dropdownUserName">Administrador</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="darkModeToggle">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                        <span id="darkModeText">Modo Oscuro</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/bischeduler/dashboard">
                        <i class="fas fa-home"></i> Panel Principal
                    </a>
                    <button class="dropdown-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="exam-calendar">
        <div class="calendar-container">
            <!-- Calendar Header -->
            <div class="calendar-header">
                <div class="calendar-controls">
                    <div class="calendar-navigation">
                        <button class="nav-button" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="current-month" id="currentMonth">Octubre 2025</div>
                        <button class="nav-button" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div class="exam-filters">
                        <select class="filter-select" id="examTypeFilter">
                            <option value="">Todos los tipos</option>
                            <option value="parcial">Parciales</option>
                            <option value="final">Finales</option>
                            <option value="recuperacion">Recuperaci√≥n</option>
                            <option value="extraordinario">Extraordinarios</option>
                        </select>

                        <select class="filter-select" id="sectionFilter">
                            <option value="">Todas las secciones</option>
                            <option value="1">1er a√±o</option>
                            <option value="2">2do a√±o</option>
                            <option value="3">3er a√±o</option>
                            <option value="4">4to a√±o</option>
                            <option value="5">5to a√±o</option>
                        </select>

                        <button class="btn-exam btn-primary-exam" onclick="scheduleNewExam()">
                            <i class="fas fa-plus"></i>
                            Programar Examen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-number" id="totalExamsThisMonth">12</div>
                    <div class="stat-label">Ex√°menes este mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="examsToday">3</div>
                    <div class="stat-label">Ex√°menes hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="supervisorsAssigned">8</div>
                    <div class="stat-label">Supervisores asignados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conflictsDetected">2</div>
                    <div class="stat-label">Conflictos detectados</div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
                <table class="calendar-table">
                    <thead>
                        <tr class="calendar-header-row">
                            <th class="calendar-header-cell">Domingo</th>
                            <th class="calendar-header-cell">Lunes</th>
                            <th class="calendar-header-cell">Martes</th>
                            <th class="calendar-header-cell">Mi√©rcoles</th>
                            <th class="calendar-header-cell">Jueves</th>
                            <th class="calendar-header-cell">Viernes</th>
                            <th class="calendar-header-cell">S√°bado</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        <!-- Calendar days will be dynamically generated -->
                    </tbody>
                </table>
            </div>

            <!-- Calendar Legend -->
            <div class="calendar-legend">
                <div class="legend-title">Tipos de Ex√°menes</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #28a745, #20c997);"></div>
                        <span>Parciales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #dc3545, #e83e8c);"></div>
                        <span>Finales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #fd7e14, #ffc107);"></div>
                        <span>Recuperaci√≥n</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);"></div>
                        <span>Extraordinarios</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Details Sidebar -->
    <div class="exam-details-sidebar" id="examDetailsSidebar">
        <div class="sidebar-header">
            <h3>Detalles del Examen</h3>
            <button class="close-sidebar" onclick="closeSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="exam-info-section">
            <div class="section-title">
                <i class="fas fa-info-circle"></i>
                Informaci√≥n General
            </div>
            <div class="info-item">
                <span class="info-label">Examen:</span>
                <span class="info-value" id="examNameDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Tipo:</span>
                <span class="info-value" id="examTypeDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Materia:</span>
                <span class="info-value" id="examSubjectDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Secci√≥n:</span>
                <span class="info-value" id="examSectionDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Fecha y Hora:</span>
                <span class="info-value" id="examDateTimeDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Duraci√≥n:</span>
                <span class="info-value" id="examDurationDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Aula:</span>
                <span class="info-value" id="examClassroomDetail">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Estudiantes:</span>
                <span class="info-value" id="examStudentsDetail">-</span>
            </div>
        </div>

        <div class="exam-info-section">
            <div class="section-title">
                <i class="fas fa-user-tie"></i>
                Supervisores Asignados
            </div>
            <div id="supervisorsList">
                <!-- Supervisors will be loaded here -->
            </div>
        </div>

        <div class="exam-info-section">
            <div class="section-title">
                <i class="fas fa-exclamation-triangle"></i>
                Estado y Conflictos
            </div>
            <div class="info-item">
                <span class="info-label">Estado:</span>
                <span class="info-value" id="examStatusDetail">-</span>
            </div>
            <div id="conflictsList">
                <!-- Conflicts will be loaded here -->
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-exam btn-primary-exam" onclick="editExam()">
                <i class="fas fa-edit"></i>
                Editar
            </button>
            <button class="btn-exam btn-secondary-exam" onclick="assignSupervisors()">
                <i class="fas fa-user-plus"></i>
                Supervisores
            </button>
        </div>
    </div>

    <!-- Bootstrap Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Exam Calendar JavaScript
        class ExamCalendar {
            constructor() {
                this.currentDate = new Date();
                this.selectedExam = null;
                this.exams = {}; // Store exams by date
                this.init();
            }

            init() {
                this.initializeTheme();
                this.loadExamData();
                this.renderCalendar();
                this.setupEventListeners();
            }

            initializeTheme() {
                const savedTheme = localStorage.getItem('bischeduler-theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
                this.setTheme(initialTheme);

                // Setup dark mode toggle
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) {
                    darkModeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                localStorage.setItem('bischeduler-theme', newTheme);
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);

                const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                if (metaThemeColor) {
                    metaThemeColor.setAttribute('content', theme === 'dark' ? '#1a1a1a' : '#003366');
                }

                // Update toggle icon and text
                const icon = document.getElementById('darkModeIcon');
                const text = document.getElementById('darkModeText');
                if (icon && text) {
                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Modo Claro';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Modo Oscuro';
                    }
                }
            }

            setupEventListeners() {
                // Calendar navigation
                window.changeMonth = (direction) => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                    this.renderCalendar();
                };

                // Filter changes
                document.getElementById('examTypeFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('sectionFilter').addEventListener('change', () => this.applyFilters());

                // Global functions
                window.scheduleNewExam = () => this.scheduleNewExam();
                window.closeSidebar = () => this.closeSidebar();
                window.editExam = () => this.editExam();
                window.assignSupervisors = () => this.assignSupervisors();
                window.handleLogout = () => this.logout();
            }

            loadExamData() {
                // Demo exam data for October 2025
                this.exams = {
                    '2025-10-15': [
                        {
                            id: 1,
                            name: 'Parcial I - Matem√°ticas',
                            type: 'parcial',
                            subject: 'MATEM√ÅTICAS',
                            section: '3er a√±o A',
                            time: '08:00 - 10:00',
                            duration: '2 horas',
                            classroom: 'Aula 3',
                            students: 28,
                            status: 'confirmed',
                            supervisors: [
                                { name: 'MARIA NIETO', role: 'Supervisor Principal', time: '07:30 - 10:30' },
                                { name: 'FLORMAR HERNANDEZ', role: 'Supervisor Auxiliar', time: '07:45 - 10:15' }
                            ]
                        }
                    ],
                    '2025-10-16': [
                        {
                            id: 2,
                            name: 'Final - F√≠sica',
                            type: 'final',
                            subject: 'F√çSICA',
                            section: '4to a√±o B',
                            time: '13:00 - 15:30',
                            duration: '2.5 horas',
                            classroom: 'Lab F√≠sica',
                            students: 25,
                            status: 'scheduled',
                            supervisors: [
                                { name: 'STEFANY ROMERO', role: 'Supervisor Principal', time: '12:30 - 16:00' }
                            ]
                        }
                    ],
                    '2025-10-22': [
                        {
                            id: 3,
                            name: 'Recuperaci√≥n - Historia',
                            type: 'recuperacion',
                            subject: 'HISTORIA DE VENEZUELA',
                            section: '5to a√±o A',
                            time: '09:00 - 11:00',
                            duration: '2 horas',
                            classroom: 'Aula 8',
                            students: 12,
                            status: 'draft',
                            supervisors: []
                        }
                    ]
                };

                // Update stats
                this.updateStats();
            }

            updateStats() {
                const currentMonth = this.currentDate.getMonth();
                const currentYear = this.currentDate.getFullYear();

                let monthlyExams = 0;
                let todayExams = 0;
                let totalSupervisors = 0;
                let conflicts = 0;

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];

                Object.entries(this.exams).forEach(([dateStr, dayExams]) => {
                    const examDate = new Date(dateStr);
                    if (examDate.getMonth() === currentMonth && examDate.getFullYear() === currentYear) {
                        monthlyExams += dayExams.length;

                        if (dateStr === todayStr) {
                            todayExams += dayExams.length;
                        }

                        dayExams.forEach(exam => {
                            totalSupervisors += exam.supervisors.length;
                            if (exam.status === 'conflict') conflicts++;
                        });
                    }
                });

                document.getElementById('totalExamsThisMonth').textContent = monthlyExams;
                document.getElementById('examsToday').textContent = todayExams;
                document.getElementById('supervisorsAssigned').textContent = totalSupervisors;
                document.getElementById('conflictsDetected').textContent = conflicts;
            }

            renderCalendar() {
                const monthNames = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];

                // Update header
                document.getElementById('currentMonth').textContent =
                    `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;

                // Calculate calendar grid
                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                const calendarBody = document.getElementById('calendarBody');
                calendarBody.innerHTML = '';

                const today = new Date();
                let currentWeek = null;

                for (let date = new Date(startDate); date <= new Date(startDate.getTime() + 41 * 24 * 60 * 60 * 1000); date.setDate(date.getDate() + 1)) {
                    if (date.getDay() === 0) {
                        currentWeek = document.createElement('tr');
                        calendarBody.appendChild(currentWeek);
                    }

                    const dayCell = document.createElement('td');
                    dayCell.className = 'calendar-day';

                    // Check if it's today
                    if (date.toDateString() === today.toDateString()) {
                        dayCell.classList.add('today');
                    }

                    // Check if it's in current month
                    if (date.getMonth() !== this.currentDate.getMonth()) {
                        dayCell.classList.add('other-month');
                    }

                    // Day number
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = date.getDate();
                    dayCell.appendChild(dayNumber);

                    // Add exams for this date
                    const dateStr = date.toISOString().split('T')[0];
                    if (this.exams[dateStr]) {
                        this.exams[dateStr].forEach(exam => {
                            if (this.shouldShowExam(exam)) {
                                const examElement = document.createElement('div');
                                examElement.className = `exam-event ${exam.type}`;
                                examElement.textContent = exam.name;
                                examElement.onclick = () => this.showExamDetails(exam);
                                dayCell.appendChild(examElement);
                            }
                        });
                    }

                    currentWeek.appendChild(dayCell);
                }

                this.updateStats();
            }

            shouldShowExam(exam) {
                const typeFilter = document.getElementById('examTypeFilter').value;
                const sectionFilter = document.getElementById('sectionFilter').value;

                if (typeFilter && exam.type !== typeFilter) return false;
                if (sectionFilter && !exam.section.includes(`${sectionFilter}er a√±o`) && !exam.section.includes(`${sectionFilter}to a√±o`)) return false;

                return true;
            }

            applyFilters() {
                this.renderCalendar();
            }

            showExamDetails(exam) {
                this.selectedExam = exam;

                // Populate sidebar with exam details
                document.getElementById('examNameDetail').textContent = exam.name;
                document.getElementById('examTypeDetail').textContent = this.getExamTypeLabel(exam.type);
                document.getElementById('examSubjectDetail').textContent = exam.subject;
                document.getElementById('examSectionDetail').textContent = exam.section;
                document.getElementById('examDateTimeDetail').textContent = exam.time;
                document.getElementById('examDurationDetail').textContent = exam.duration;
                document.getElementById('examClassroomDetail').textContent = exam.classroom;
                document.getElementById('examStudentsDetail').textContent = exam.students;
                document.getElementById('examStatusDetail').textContent = this.getStatusLabel(exam.status);

                // Populate supervisors
                const supervisorsList = document.getElementById('supervisorsList');
                supervisorsList.innerHTML = '';

                if (exam.supervisors.length === 0) {
                    supervisorsList.innerHTML = '<p class="text-muted">No hay supervisores asignados</p>';
                } else {
                    exam.supervisors.forEach(supervisor => {
                        const supervisorCard = document.createElement('div');
                        supervisorCard.className = 'supervisor-card';
                        supervisorCard.innerHTML = `
                            <div class="supervisor-role">${supervisor.role}</div>
                            <div class="supervisor-name">${supervisor.name}</div>
                            <div class="supervisor-details">Horario: ${supervisor.time}</div>
                        `;
                        supervisorsList.appendChild(supervisorCard);
                    });
                }

                // Show sidebar
                document.getElementById('examDetailsSidebar').classList.add('open');
            }

            getExamTypeLabel(type) {
                const labels = {
                    'parcial': 'Examen Parcial',
                    'final': 'Examen Final',
                    'recuperacion': 'Examen de Recuperaci√≥n',
                    'extraordinario': 'Examen Extraordinario'
                };
                return labels[type] || type;
            }

            getStatusLabel(status) {
                const labels = {
                    'draft': 'Borrador',
                    'scheduled': 'Programado',
                    'confirmed': 'Confirmado',
                    'in_progress': 'En Progreso',
                    'completed': 'Completado',
                    'cancelled': 'Cancelado'
                };
                return labels[status] || status;
            }

            closeSidebar() {
                document.getElementById('examDetailsSidebar').classList.remove('open');
            }

            scheduleNewExam() {
                alert('Programar nuevo examen - En desarrollo (Phase 6)');
            }

            editExam() {
                if (this.selectedExam) {
                    alert(`Editar examen: ${this.selectedExam.name} - En desarrollo (Phase 6)`);
                }
            }

            assignSupervisors() {
                if (this.selectedExam) {
                    alert(`Asignar supervisores a: ${this.selectedExam.name} - En desarrollo (Phase 6)`);
                }
            }

            logout() {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_info');
                window.location.href = '/bischeduler/login';
            }
        }

        // Initialize exam calendar when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ExamCalendar();
        });
    </script>
</body>
</html>