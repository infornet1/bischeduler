<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003366">
    <title>Gesti√≥n de Horarios - BiScheduler</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/bischeduler/static/css/styles.css">
    <link rel="stylesheet" href="/bischeduler/static/css/dark-mode.css">

    <style>
                /* User Bar Styles */
        .user-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: 25px;
            padding: 8px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-info .user-name {
            color: var(--text-primary, #212529);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-info .user-role {
            color: var(--text-secondary, #6c757d);
            font-size: 0.75rem;
        }

        .user-actions {
            display: flex;
            align-items: center;
        }

        .user-dropdown-toggle {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            cursor: pointer;
        }

        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle:active {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: var(--text-primary) !important;
        }

        .user-dropdown-toggle .fas {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .user-dropdown-toggle[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }

.schedule-management {
            min-height: 100vh;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: var(--spacing-lg);
        }

        .management-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .schedule-header {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .section-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            background: var(--card-bg, white);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .schedule-grid-container {
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow-lg);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            min-width: 800px;
            border-collapse: separate;
            border-spacing: 2px;
        }

        .schedule-table th {
            background: var(--primary-color, #003366);
            color: white;
            padding: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table .time-header {
            width: 100px;
            background: #002244;
        }

        .schedule-table td {
            background: var(--card-bg, white);
            border: 1px solid var(--border-color, #dee2e6);
            padding: var(--spacing-sm);
            min-height: 80px;
            vertical-align: top;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .schedule-table td:hover {
            background: var(--hover-bg, rgba(0, 51, 102, 0.05));
            box-shadow: inset 0 0 0 2px var(--primary-color, #003366);
        }

        .time-cell {
            background: var(--bg-secondary, #f8f9fa) !important;
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary, #212529);
        }

        .break-cell {
            background: repeating-linear-gradient(
                45deg,
                var(--bg-tertiary, #e9ecef),
                var(--bg-tertiary, #e9ecef) 10px,
                var(--bg-secondary, #f8f9fa) 10px,
                var(--bg-secondary, #f8f9fa) 20px
            ) !important;
            text-align: center;
            font-style: italic;
            color: var(--text-secondary, #6c757d);
        }

        .schedule-assignment {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.1), rgba(255, 204, 0, 0.1));
            border-left: 3px solid var(--primary-color, #003366);
            border-radius: 4px;
            padding: var(--spacing-xs);
            margin: 2px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            cursor: move;
            transition: var(--transition);
        }

        .schedule-assignment:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .assignment-subject {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary-color, #003366);
            margin-bottom: 2px;
        }

        .assignment-teacher {
            font-size: 0.75rem;
            color: var(--text-primary, #212529);
            margin-bottom: 2px;
        }

        .assignment-classroom {
            font-size: 0.7rem;
            color: var(--text-secondary, #6c757d);
        }

        .assignment-actions {
            position: absolute;
            top: 2px;
            right: 2px;
            display: none;
            gap: 4px;
        }

        .schedule-assignment:hover .assignment-actions {
            display: flex;
        }

        .assignment-actions button {
            background: white;
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .assignment-actions button:hover {
            background: var(--danger-color, #dc3545);
            color: white;
        }

        .empty-slot {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary, #6c757d);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .schedule-table td:hover .empty-slot {
            opacity: 1;
        }

        .conflict-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--danger-color, #dc3545);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .btn-primary-custom {
            background: var(--primary-color, #003366);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn-primary-custom:hover {
            background: #004080;
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--box-shadow);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--card-bg, white);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color, #003366);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary, #6c757d);
        }

        .legend {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .schedule-management {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        [data-theme="dark"] .time-cell {
            background: #2d2d2d !important;
        }

        [data-theme="dark"] .break-cell {
            background: repeating-linear-gradient(
                45deg,
                #404040,
                #404040 10px,
                #2d2d2d 10px,
                #2d2d2d 20px
            ) !important;
        }

        [data-theme="dark"] .schedule-assignment {
            background: linear-gradient(135deg, rgba(109, 163, 208, 0.2), rgba(255, 204, 0, 0.1));
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: rgba(0, 123, 255, 0.1) !important;
            box-shadow: inset 0 0 0 2px var(--info-color, #17a2b8);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .schedule-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .section-selector {
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <span class="user-name">Gesti√≥n de Horarios</span>
            <span class="user-role">Sistema Completo</span>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="user-dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="fas fa-user-circle"></i>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <button class="dropdown-item" id="darkModeToggle">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                        <span id="darkModeText">Modo Oscuro</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/bischeduler/dashboard">
                        <i class="fas fa-home"></i> Panel Principal
                    </a>
                    <button class="dropdown-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="schedule-management">
        <div class="management-container">
            <!-- Header Section -->
            <div class="schedule-header">
                <h1><i class="fas fa-calendar-alt"></i> Gesti√≥n Completa de Horarios</h1>
                <p class="text-muted mb-3">Crear, editar y gestionar horarios acad√©micos K12</p>

                <!-- Statistics -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAssignments">0</div>
                        <div class="stat-label">Asignaciones Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teacherWorkload">0</div>
                        <div class="stat-label">Horas Asignadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="freeSlots">0</div>
                        <div class="stat-label">Espacios Libres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-danger" id="conflictCount">0</div>
                        <div class="stat-label">Conflictos</div>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="schedule-controls">
                <div class="section-selector">
                    <label class="mb-0 mr-2">Ver horario de:</label>
                    <select class="form-control" id="viewSelector" style="width: 200px;">
                        <option value="section">Por Secci√≥n</option>
                        <option value="teacher">Por Profesor</option>
                        <option value="classroom">Por Aula</option>
                    </select>
                    <select class="form-control" id="targetSelector" style="width: 200px;">
                        <option value="">Seleccione...</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary-custom" onclick="openAssignmentModal()">
                        <i class="fas fa-plus"></i> Nueva Asignaci√≥n
                    </button>
                    <button class="btn-primary-custom" onclick="generateSchedule()">
                        <i class="fas fa-magic"></i> Generar Autom√°tico
                    </button>
                    <button class="btn-primary-custom" onclick="checkConflicts()">
                        <i class="fas fa-exclamation-triangle"></i> Ver Conflictos
                    </button>
                    <button class="btn btn-success" onclick="exportSchedule()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                    <button class="btn btn-info" onclick="printSchedule()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>

            <!-- Schedule Grid -->
            <div class="schedule-grid-container">
                <table class="schedule-table" id="scheduleTable">
                    <thead>
                        <tr>
                            <th class="time-header">Hora</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Mi√©rcoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <!-- Schedule grid will be populated here -->
                    </tbody>
                </table>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.1), rgba(255, 204, 0, 0.1)); border-left: 3px solid #003366;"></div>
                        <span>Clase Asignada</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: repeating-linear-gradient(45deg, #e9ecef, #e9ecef 10px, #f8f9fa 10px, #f8f9fa 20px);"></div>
                        <span>Recreo/Descanso</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color conflict-indicator" style="position: relative;">!</div>
                        <span>Conflicto Detectado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-color, #003366); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i> Nueva Asignaci√≥n de Horario
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="assignmentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Secci√≥n <span class="text-danger">*</span></label>
                                    <select class="form-control" id="sectionSelect" required>
                                        <option value="">Seleccione secci√≥n...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Materia <span class="text-danger">*</span></label>
                                    <select class="form-control" id="subjectSelect" required>
                                        <option value="">Seleccione materia...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Profesor <span class="text-danger">*</span></label>
                                    <select class="form-control" id="teacherSelect" required>
                                        <option value="">Seleccione profesor...</option>
                                    </select>
                                    <small class="form-text text-muted" id="teacherWorkloadInfo">
                                        Carga horaria: --/40 horas
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Aula <span class="text-danger">*</span></label>
                                    <select class="form-control" id="classroomSelect" required>
                                        <option value="">Seleccione aula...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>D√≠a <span class="text-danger">*</span></label>
                                    <select class="form-control" id="daySelect" required>
                                        <option value="">Seleccione d√≠a...</option>
                                        <option value="lunes">Lunes</option>
                                        <option value="martes">Martes</option>
                                        <option value="miercoles">Mi√©rcoles</option>
                                        <option value="jueves">Jueves</option>
                                        <option value="viernes">Viernes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Per√≠odo <span class="text-danger">*</span></label>
                                    <select class="form-control" id="periodSelect" required>
                                        <option value="">Seleccione per√≠odo...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Conflict Check -->
                        <div class="alert alert-warning" id="conflictAlert" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="conflictMessage"></span>
                        </div>

                        <!-- Success Message -->
                        <div class="alert alert-success" id="successAlert" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            Asignaci√≥n v√°lida - No se detectan conflictos
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveAssignmentBtn" onclick="saveAssignment()">
                        <i class="fas fa-save"></i> Guardar Asignaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflicts Modal -->
    <div class="modal fade" id="conflictsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--danger-color, #dc3545); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Conflictos Detectados
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="conflictsList">
                        <!-- Conflicts will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="resolveAllConflicts()">
                        <i class="fas fa-magic"></i> Resolver Autom√°ticamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Schedule Management System
        class ScheduleManager {
            constructor() {
                this.currentView = 'section';
                this.currentTarget = null;
                this.scheduleData = {};
                this.timePeriods = [];
                this.sections = [];
                this.teachers = [];
                this.subjects = [];
                this.classrooms = [];
                this.conflicts = [];
                this.init();
            }

            init() {
                this.initializeTheme();
                this.loadMasterData();
                this.setupEventListeners();
                this.loadDefaultSchedule();
            }

            initializeTheme() {
                const savedTheme = localStorage.getItem('bischeduler-theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);
                this.updateThemeToggle(theme);
            }

            updateThemeToggle(theme) {
                const icon = document.getElementById('darkModeIcon');
                const text = document.getElementById('darkModeText');
                if (icon && text) {
                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Modo Claro';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Modo Oscuro';
                    }
                }
            }

            setupEventListeners() {
                // Dark mode toggle
                document.getElementById('darkModeToggle').addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('bischeduler-theme', newTheme);
                    this.updateThemeToggle(newTheme);
                });

                // View selector
                document.getElementById('viewSelector').addEventListener('change', (e) => {
                    this.currentView = e.target.value;
                    this.updateTargetSelector();
                });

                // Target selector
                document.getElementById('targetSelector').addEventListener('change', (e) => {
                    this.currentTarget = e.target.value;
                    if (this.currentTarget) {
                        this.loadSchedule();
                    }
                });

                // Form field changes for conflict checking
                ['sectionSelect', 'teacherSelect', 'classroomSelect', 'daySelect', 'periodSelect'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.checkAssignmentConflicts());
                    }
                });

                // Teacher selection updates workload info
                document.getElementById('teacherSelect').addEventListener('change', (e) => {
                    this.updateTeacherWorkload(e.target.value);
                });
            }

            async loadMasterData() {
                try {
                    // Load time periods (Venezuelan schedule)
                    this.timePeriods = [
                        { id: 1, name: 'P1', start_time: '07:00', end_time: '07:40', is_break: false },
                        { id: 2, name: 'P2', start_time: '07:40', end_time: '08:20', is_break: false },
                        { id: 3, name: 'P3', start_time: '08:20', end_time: '09:00', is_break: false },
                        { id: 4, name: 'P4', start_time: '09:00', end_time: '09:40', is_break: false },
                        { id: 5, name: 'Recreo', start_time: '09:40', end_time: '10:00', is_break: true },
                        { id: 6, name: 'P5', start_time: '10:00', end_time: '10:40', is_break: false },
                        { id: 7, name: 'P6', start_time: '10:40', end_time: '11:20', is_break: false },
                        { id: 8, name: 'P7', start_time: '11:20', end_time: '12:00', is_break: false },
                        { id: 9, name: 'P8', start_time: '12:00', end_time: '12:40', is_break: false },
                        { id: 10, name: 'Almuerzo', start_time: '12:40', end_time: '13:00', is_break: true },
                        { id: 11, name: 'P9', start_time: '13:00', end_time: '13:40', is_break: false },
                        { id: 12, name: 'P10', start_time: '13:40', end_time: '14:20', is_break: false }
                    ];

                    // Load sections
                    this.sections = [
                        { id: 1, name: '1er a√±o A', grade: '1er a√±o' },
                        { id: 2, name: '1er a√±o B', grade: '1er a√±o' },
                        { id: 3, name: '2do a√±o A', grade: '2do a√±o' },
                        { id: 4, name: '2do a√±o B', grade: '2do a√±o' },
                        { id: 5, name: '3er a√±o A', grade: '3er a√±o' },
                        { id: 6, name: '3er a√±o B', grade: '3er a√±o' },
                        { id: 7, name: '4to a√±o A', grade: '4to a√±o' },
                        { id: 8, name: '4to a√±o B', grade: '4to a√±o' },
                        { id: 9, name: '5to a√±o A', grade: '5to a√±o' },
                        { id: 10, name: '5to a√±o B', grade: '5to a√±o' }
                    ];

                    // Load teachers
                    this.teachers = [
                        { id: 1, name: 'MARIA NIETO', specialization: 'Matem√°ticas' },
                        { id: 2, name: 'JUAN PEREZ', specialization: 'F√≠sica' },
                        { id: 3, name: 'ANA RODRIGUEZ', specialization: 'Castellano' },
                        { id: 4, name: 'CARLOS MENDEZ', specialization: 'Historia' },
                        { id: 5, name: 'LUCIA GARCIA', specialization: 'Ingl√©s' }
                    ];

                    // Load subjects
                    this.subjects = [
                        { id: 1, name: 'CASTELLANO Y LITERATURA' },
                        { id: 2, name: 'INGL√âS' },
                        { id: 3, name: 'MATEM√ÅTICAS' },
                        { id: 4, name: 'F√çSICA' },
                        { id: 5, name: 'QU√çMICA' },
                        { id: 6, name: 'BIOLOG√çA' },
                        { id: 7, name: 'GHC PARA LA SOBERANIA NACIONAL' },
                        { id: 8, name: 'EDUCACI√ìN F√çSICA' }
                    ];

                    // Load classrooms
                    this.classrooms = [
                        { id: 1, name: 'Aula 1', capacity: 30 },
                        { id: 2, name: 'Aula 2', capacity: 30 },
                        { id: 3, name: 'Aula 3', capacity: 30 },
                        { id: 4, name: 'Lab F√≠sica', capacity: 25 },
                        { id: 5, name: 'Lab Qu√≠mica', capacity: 25 },
                        { id: 6, name: 'Cancha 1', capacity: 50 }
                    ];

                    this.populateFormSelects();
                    this.updateTargetSelector();

                } catch (error) {
                    console.error('Error loading master data:', error);
                }
            }

            populateFormSelects() {
                // Populate sections
                const sectionSelect = document.getElementById('sectionSelect');
                sectionSelect.innerHTML = '<option value="">Seleccione secci√≥n...</option>';
                this.sections.forEach(section => {
                    sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                });

                // Populate subjects
                const subjectSelect = document.getElementById('subjectSelect');
                subjectSelect.innerHTML = '<option value="">Seleccione materia...</option>';
                this.subjects.forEach(subject => {
                    subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                });

                // Populate teachers
                const teacherSelect = document.getElementById('teacherSelect');
                teacherSelect.innerHTML = '<option value="">Seleccione profesor...</option>';
                this.teachers.forEach(teacher => {
                    teacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name} (${teacher.specialization})</option>`;
                });

                // Populate classrooms
                const classroomSelect = document.getElementById('classroomSelect');
                classroomSelect.innerHTML = '<option value="">Seleccione aula...</option>';
                this.classrooms.forEach(classroom => {
                    classroomSelect.innerHTML += `<option value="${classroom.id}">${classroom.name} (Cap: ${classroom.capacity})</option>`;
                });

                // Populate periods
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = '<option value="">Seleccione per√≠odo...</option>';
                this.timePeriods.forEach(period => {
                    if (!period.is_break) {
                        periodSelect.innerHTML += `<option value="${period.id}">${period.name}: ${period.start_time} - ${period.end_time}</option>`;
                    }
                });
            }

            updateTargetSelector() {
                const targetSelector = document.getElementById('targetSelector');
                targetSelector.innerHTML = '<option value="">Seleccione...</option>';

                switch (this.currentView) {
                    case 'section':
                        this.sections.forEach(section => {
                            targetSelector.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                        });
                        break;
                    case 'teacher':
                        this.teachers.forEach(teacher => {
                            targetSelector.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
                        });
                        break;
                    case 'classroom':
                        this.classrooms.forEach(classroom => {
                            targetSelector.innerHTML += `<option value="${classroom.id}">${classroom.name}</option>`;
                        });
                        break;
                }
            }

            loadDefaultSchedule() {
                // Load first section by default
                if (this.sections.length > 0) {
                    this.currentTarget = this.sections[0].id;
                    document.getElementById('targetSelector').value = this.currentTarget;
                    this.loadSchedule();
                }
            }

            async loadSchedule() {
                this.showLoading(true);
                try {
                    // For demo, generate sample schedule data
                    this.generateSampleSchedule();
                    this.renderScheduleGrid();
                    this.updateStatistics();
                } catch (error) {
                    console.error('Error loading schedule:', error);
                } finally {
                    this.showLoading(false);
                }
            }

            generateSampleSchedule() {
                // Generate some sample assignments for demonstration
                this.scheduleData = {};
                const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];

                // Add some sample assignments
                if (this.currentView === 'section' && this.currentTarget) {
                    // Sample assignments for a section
                    this.scheduleData = {
                        'lunes_1': { subject: 'MATEM√ÅTICAS', teacher: 'MARIA NIETO', classroom: 'Aula 3' },
                        'lunes_3': { subject: 'F√çSICA', teacher: 'JUAN PEREZ', classroom: 'Lab F√≠sica' },
                        'martes_2': { subject: 'CASTELLANO', teacher: 'ANA RODRIGUEZ', classroom: 'Aula 1' },
                        'martes_4': { subject: 'INGL√âS', teacher: 'LUCIA GARCIA', classroom: 'Aula 2' },
                        'miercoles_1': { subject: 'QU√çMICA', teacher: 'CARLOS MENDEZ', classroom: 'Lab Qu√≠mica' },
                        'jueves_3': { subject: 'BIOLOG√çA', teacher: 'ANA RODRIGUEZ', classroom: 'Aula 3' },
                        'viernes_2': { subject: 'EDUCACI√ìN F√çSICA', teacher: 'JUAN PEREZ', classroom: 'Cancha 1' }
                    };
                }
            }

            renderScheduleGrid() {
                const tbody = document.getElementById('scheduleBody');
                tbody.innerHTML = '';

                this.timePeriods.forEach(period => {
                    const row = document.createElement('tr');

                    // Time cell
                    const timeCell = document.createElement('td');
                    timeCell.className = period.is_break ? 'break-cell' : 'time-cell';
                    timeCell.innerHTML = period.is_break ?
                        `<em>${period.name}</em>` :
                        `<strong>${period.name}</strong><br><small>${period.start_time}-${period.end_time}</small>`;
                    row.appendChild(timeCell);

                    // Day cells
                    ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'].forEach(day => {
                        const cell = document.createElement('td');

                        if (period.is_break) {
                            cell.className = 'break-cell';
                            cell.innerHTML = '-';
                        } else {
                            const key = `${day}_${period.id}`;
                            const assignment = this.scheduleData[key];

                            if (assignment) {
                                cell.innerHTML = this.createAssignmentElement(assignment, key);
                            } else {
                                cell.innerHTML = '<div class="empty-slot"><i class="fas fa-plus"></i> Agregar</div>';
                                cell.onclick = () => this.quickAddAssignment(day, period.id);
                            }

                            // Enable drag and drop
                            cell.ondrop = (e) => this.handleDrop(e, day, period.id);
                            cell.ondragover = (e) => this.handleDragOver(e);
                            cell.ondragleave = (e) => this.handleDragLeave(e);
                        }

                        row.appendChild(cell);
                    });

                    tbody.appendChild(row);
                });
            }

            createAssignmentElement(assignment, key) {
                const hasConflict = this.checkForConflicts(key);
                return `
                    <div class="schedule-assignment" draggable="true" ondragstart="scheduleManager.handleDragStart(event, '${key}')">
                        ${hasConflict ? '<div class="conflict-indicator">!</div>' : ''}
                        <div class="assignment-subject">${assignment.subject}</div>
                        <div class="assignment-teacher">${assignment.teacher}</div>
                        <div class="assignment-classroom">${assignment.classroom}</div>
                        <div class="assignment-actions">
                            <button onclick="scheduleManager.editAssignment('${key}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="scheduleManager.deleteAssignment('${key}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            checkForConflicts(key) {
                // Simple conflict check for demonstration
                // In production, this would check against actual database
                return Math.random() > 0.9; // 10% chance of conflict for demo
            }

            updateStatistics() {
                const assignments = Object.keys(this.scheduleData).length;
                const totalSlots = this.timePeriods.filter(p => !p.is_break).length * 5; // 5 days
                const freeSlots = totalSlots - assignments;
                const conflictCount = Math.floor(Math.random() * 3); // Demo conflicts

                document.getElementById('totalAssignments').textContent = assignments;
                document.getElementById('teacherWorkload').textContent = assignments * 40 / 60; // Convert to hours
                document.getElementById('freeSlots').textContent = freeSlots;
                document.getElementById('conflictCount').textContent = conflictCount;
            }

            quickAddAssignment(day, periodId) {
                // Pre-fill the form with the selected slot
                document.getElementById('daySelect').value = day;
                document.getElementById('periodSelect').value = periodId;
                this.openAssignmentModal();
            }

            editAssignment(key) {
                const assignment = this.scheduleData[key];
                // Load assignment data into form
                alert(`Editar asignaci√≥n: ${assignment.subject}`);
            }

            deleteAssignment(key) {
                if (confirm('¬øEst√° seguro de eliminar esta asignaci√≥n?')) {
                    delete this.scheduleData[key];
                    this.renderScheduleGrid();
                    this.updateStatistics();
                }
            }

            // Drag and Drop handlers
            handleDragStart(e, key) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('assignmentKey', key);
                e.target.classList.add('dragging');
            }

            handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('drag-over');
                return false;
            }

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            handleDrop(e, day, periodId) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                e.currentTarget.classList.remove('drag-over');

                const sourceKey = e.dataTransfer.getData('assignmentKey');
                const targetKey = `${day}_${periodId}`;

                if (sourceKey !== targetKey) {
                    // Move assignment
                    const assignment = this.scheduleData[sourceKey];
                    if (assignment) {
                        this.scheduleData[targetKey] = assignment;
                        delete this.scheduleData[sourceKey];
                        this.renderScheduleGrid();
                        this.updateStatistics();
                    }
                }

                return false;
            }

            openAssignmentModal() {
                $('#assignmentModal').modal('show');
            }

            async checkAssignmentConflicts() {
                const teacherId = document.getElementById('teacherSelect').value;
                const classroomId = document.getElementById('classroomSelect').value;
                const day = document.getElementById('daySelect').value;
                const periodId = document.getElementById('periodSelect').value;

                if (teacherId && day && periodId) {
                    // Check for conflicts
                    const conflicts = [];

                    // Check teacher conflict
                    // In production, this would check against actual database

                    if (conflicts.length > 0) {
                        document.getElementById('conflictAlert').style.display = 'block';
                        document.getElementById('conflictMessage').textContent = conflicts.join(', ');
                        document.getElementById('successAlert').style.display = 'none';
                    } else {
                        document.getElementById('conflictAlert').style.display = 'none';
                        document.getElementById('successAlert').style.display = 'block';
                    }
                }
            }

            updateTeacherWorkload(teacherId) {
                if (teacherId) {
                    const teacher = this.teachers.find(t => t.id == teacherId);
                    if (teacher) {
                        const currentHours = Math.floor(Math.random() * 30) + 10; // Demo hours
                        document.getElementById('teacherWorkloadInfo').textContent =
                            `Carga horaria: ${currentHours}/40 horas`;
                    }
                }
            }

            async saveAssignment() {
                const form = document.getElementById('assignmentForm');
                if (form.checkValidity()) {
                    const data = {
                        section_id: document.getElementById('sectionSelect').value,
                        subject_id: document.getElementById('subjectSelect').value,
                        teacher_id: document.getElementById('teacherSelect').value,
                        classroom_id: document.getElementById('classroomSelect').value,
                        day_of_week: document.getElementById('daySelect').value,
                        time_period_id: document.getElementById('periodSelect').value
                    };

                    try {
                        // In production, this would save to database via API
                        const key = `${data.day_of_week}_${data.time_period_id}`;
                        const subject = this.subjects.find(s => s.id == data.subject_id);
                        const teacher = this.teachers.find(t => t.id == data.teacher_id);
                        const classroom = this.classrooms.find(c => c.id == data.classroom_id);

                        this.scheduleData[key] = {
                            subject: subject.name,
                            teacher: teacher.name,
                            classroom: classroom.name
                        };

                        $('#assignmentModal').modal('hide');
                        form.reset();
                        this.renderScheduleGrid();
                        this.updateStatistics();

                        alert('Asignaci√≥n guardada exitosamente');

                    } catch (error) {
                        console.error('Error saving assignment:', error);
                        alert('Error al guardar la asignaci√≥n');
                    }
                } else {
                    form.reportValidity();
                }
            }

            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            }
        }

        // Global functions
        const scheduleManager = new ScheduleManager();

        function openAssignmentModal() {
            scheduleManager.openAssignmentModal();
        }

        function saveAssignment() {
            scheduleManager.saveAssignment();
        }

        function generateSchedule() {
            if (confirm('¬øDesea generar un horario autom√°tico? Esto reemplazar√° las asignaciones actuales.')) {
                alert('Generador de horarios - Funcionalidad en desarrollo (Phase 6.5B)');
            }
        }

        function checkConflicts() {
            $('#conflictsModal').modal('show');
            // Load conflicts
            const conflictsList = document.getElementById('conflictsList');
            conflictsList.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Sistema de detecci√≥n de conflictos - En desarrollo
                </div>
                <p>Los conflictos detectados aparecer√°n aqu√≠ con opciones para resolverlos.</p>
            `;
        }

        function resolveAllConflicts() {
            alert('Resoluci√≥n autom√°tica de conflictos - En desarrollo');
        }

        function exportSchedule() {
            alert('Exportar a Excel - Conectando con sistema de exportaci√≥n...');
            // This would connect to the existing Excel export functionality
        }

        function printSchedule() {
            window.print();
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            window.location.href = '/bischeduler/login';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Schedule Management System initialized');
        });
    </script>
</body>
</html>