<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003366">
    <title>Gesti√≥n de Horarios - BiScheduler</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/bischeduler/static/css/styles.css">
    <link rel="stylesheet" href="/bischeduler/static/css/dark-mode.css">

    <style>
                /* User Bar Styles */
        .user-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--card-bg, rgba(255, 255, 255, 0.95));
            border-radius: 25px;
            padding: 8px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-info .user-name {
            color: var(--text-primary, #212529);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-info .user-role {
            color: var(--text-secondary, #6c757d);
            font-size: 0.75rem;
        }

        .user-actions {
            display: flex;
            align-items: center;
        }

        .user-dropdown-toggle {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            cursor: pointer;
        }

        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle:active {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: var(--text-primary) !important;
        }

        .user-dropdown-toggle .fas {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .user-dropdown-toggle[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }

.schedule-management {
            min-height: 100vh;
            background: linear-gradient(135deg, #003366 0%, #004080 100%);
            padding: 20px;
        }

        .management-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .schedule-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .schedule-grid-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            min-width: 800px;
            border-collapse: separate;
            border-spacing: 2px;
        }

        .schedule-table th {
            background: #003366;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table .time-header {
            width: 100px;
            background: #002244;
        }

        .schedule-table td {
            background: var(--card-bg, white);
            border: 1px solid var(--border-color, #dee2e6);
            padding: var(--spacing-sm);
            min-height: 80px;
            vertical-align: top;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
        }

        .schedule-table td:hover {
            background: var(--hover-bg, rgba(0, 51, 102, 0.05));
            box-shadow: inset 0 0 0 2px var(--primary-color, #003366);
        }

        .time-cell {
            background: var(--bg-secondary, #f8f9fa) !important;
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary, #212529);
        }

        .break-cell {
            background: repeating-linear-gradient(
                45deg,
                var(--bg-tertiary, #e9ecef),
                var(--bg-tertiary, #e9ecef) 10px,
                var(--bg-secondary, #f8f9fa) 10px,
                var(--bg-secondary, #f8f9fa) 20px
            ) !important;
            text-align: center;
            font-style: italic;
            color: var(--text-secondary, #6c757d);
        }

        .schedule-assignment {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.1), rgba(255, 204, 0, 0.1));
            border-left: 3px solid var(--primary-color, #003366);
            border-radius: 4px;
            padding: var(--spacing-xs);
            margin: 2px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            cursor: move;
            transition: var(--transition);
        }

        .schedule-assignment:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .assignment-subject {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary-color, #003366);
            margin-bottom: 2px;
        }

        .assignment-teacher {
            font-size: 0.75rem;
            color: var(--text-primary, #212529);
            margin-bottom: 2px;
        }

        .assignment-classroom {
            font-size: 0.7rem;
            color: var(--text-secondary, #6c757d);
        }

        .assignment-actions {
            position: absolute;
            top: 2px;
            right: 2px;
            display: none;
            gap: 4px;
        }

        .schedule-assignment:hover .assignment-actions {
            display: flex;
        }

        .assignment-actions button {
            background: white;
            border: 1px solid var(--border-color, #dee2e6);
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .assignment-actions button:hover {
            background: var(--danger-color, #dc3545);
            color: white;
        }

        .empty-slot {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary, #6c757d);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .schedule-table td:hover .empty-slot {
            opacity: 1;
        }

        .conflict-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--danger-color, #dc3545);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-primary-custom {
            background: #003366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary-custom:hover {
            background: #004080;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-decoration: none;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        /* Responsive: stack on mobile */
        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .stats-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s ease;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #003366;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        .legend {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.85rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .schedule-management {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        [data-theme="dark"] .time-cell {
            background: #2d2d2d !important;
        }

        [data-theme="dark"] .break-cell {
            background: repeating-linear-gradient(
                45deg,
                #404040,
                #404040 10px,
                #2d2d2d 10px,
                #2d2d2d 20px
            ) !important;
        }

        [data-theme="dark"] .schedule-assignment {
            background: linear-gradient(135deg, rgba(109, 163, 208, 0.2), rgba(255, 204, 0, 0.1));
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: rgba(0, 123, 255, 0.1) !important;
            box-shadow: inset 0 0 0 2px var(--info-color, #17a2b8);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .schedule-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .section-selector {
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        /* Comprehensive dark mode text fixes */
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: var(--text-primary, #ffffff) !important;
        }

        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div,
        [data-theme="dark"] label,
        [data-theme="dark"] .navbar-brand,
        [data-theme="dark"] .nav-link,
        [data-theme="dark"] .breadcrumb-item,
        [data-theme="dark"] .alert,
        [data-theme="dark"] .btn,
        [data-theme="dark"] .dropdown-item,
        [data-theme="dark"] .card-title,
        [data-theme="dark"] .card-text,
        [data-theme="dark"] .form-label,
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .table,
        [data-theme="dark"] .table td,
        [data-theme="dark"] .table th {
            color: var(--text-primary, #ffffff) !important;
        }

        [data-theme="dark"] .text-primary {
            color: var(--text-primary, #ffffff) !important;
        }

        [data-theme="dark"] .text-secondary {
            color: var(--text-secondary, #b0b0b0) !important;
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary, #b0b0b0) !important;
        }

        /* Dark mode fixes for schedule management */
        [data-theme="dark"] .schedule-header {
            background: rgba(30, 30, 30, 0.95) !important;
        }

        [data-theme="dark"] .section-selector {
            background: rgba(40, 40, 40, 0.95) !important;
        }

        [data-theme="dark"] .schedule-grid-container {
            background: rgba(30, 30, 30, 0.95) !important;
        }

        [data-theme="dark"] .stat-card {
            background: rgba(40, 40, 40, 0.95) !important;
        }

        [data-theme="dark"] .stat-value {
            color: #ffffff !important;
        }

        [data-theme="dark"] .stat-label {
            color: #b0b0b0 !important;
        }

        /* Footer styles */
        .footer-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin: 20px;
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            clear: both;
        }

        .tenant-info {
            text-align: center;
            color: #6c757d;
        }

        .tenant-info strong {
            color: #003366;
            font-weight: 600;
        }

        /* Dark mode footer */
        [data-theme="dark"] .footer-section {
            background: rgba(30, 30, 30, 0.95) !important;
        }

        [data-theme="dark"] .tenant-info {
            color: #b0b0b0 !important;
        }

        [data-theme="dark"] .tenant-info strong {
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <!-- User Bar -->
    <div class="user-bar">
        <div class="user-info">
            <span class="user-name">Gesti√≥n de Horarios</span>
            <span class="user-role">Sistema Completo</span>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="user-dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="fas fa-user-circle"></i>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <button class="dropdown-item" id="darkModeToggle">
                        <i class="fas fa-moon" id="darkModeIcon"></i>
                        <span id="darkModeText">Modo Oscuro</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/bischeduler/dashboard">
                        <i class="fas fa-home"></i> Panel Principal
                    </a>
                    <button class="dropdown-item" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="schedule-management">
        <div class="management-container">
            <!-- Header Section -->
            <div class="schedule-header">
                <h1><i class="fas fa-calendar-alt"></i> Gesti√≥n Completa de Horarios</h1>
                <p class="text-muted mb-3">Crear, editar y gestionar horarios acad√©micos K12</p>

                <!-- Statistics -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAssignments">0</div>
                        <div class="stat-label">Asignaciones Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="teacherWorkload">0</div>
                        <div class="stat-label">Horas Asignadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="freeSlots">0</div>
                        <div class="stat-label">Espacios Libres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-danger" id="conflictCount">0</div>
                        <div class="stat-label">Conflictos</div>
                    </div>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="schedule-controls">
                <div class="section-selector">
                    <label class="mb-0 mr-2">Ver horario de:</label>
                    <select class="form-control" id="viewSelector" style="width: 200px;">
                        <option value="section">Por Secci√≥n</option>
                        <option value="teacher">Por Profesor</option>
                        <option value="classroom">Por Aula</option>
                    </select>
                    <select class="form-control" id="targetSelector" style="width: 200px;">
                        <option value="">Seleccione...</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary-custom" onclick="openAssignmentModal()">
                        <i class="fas fa-plus"></i> Nueva Asignaci√≥n
                    </button>
                    <button class="btn-primary-custom" onclick="generateSchedule()">
                        <i class="fas fa-magic"></i> Generar Autom√°tico
                    </button>
                    <button class="btn-primary-custom" onclick="checkConflicts()">
                        <i class="fas fa-exclamation-triangle"></i> Ver Conflictos
                    </button>
                    <button class="btn btn-success" onclick="exportSchedule()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                    <button class="btn btn-info" onclick="printSchedule()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="btn btn-warning" onclick="validateVenezuelanK12()">
                        <i class="fas fa-flag"></i> Validar K12-VE
                    </button>
                </div>
            </div>

            <!-- Schedule Grid -->
            <div class="schedule-grid-container">
                <table class="schedule-table" id="scheduleTable">
                    <thead>
                        <tr>
                            <th class="time-header">Hora</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Mi√©rcoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <!-- Schedule grid will be populated here -->
                    </tbody>
                </table>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, rgba(0, 51, 102, 0.1), rgba(255, 204, 0, 0.1)); border-left: 3px solid #003366;"></div>
                        <span>Clase Asignada</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: repeating-linear-gradient(45deg, #e9ecef, #e9ecef 10px, #f8f9fa 10px, #f8f9fa 20px);"></div>
                        <span>Recreo/Descanso</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color conflict-indicator" style="position: relative;">!</div>
                        <span>Conflicto Detectado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-color, #003366); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i> Nueva Asignaci√≥n de Horario
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="assignmentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Secci√≥n <span class="text-danger">*</span></label>
                                    <select class="form-control" id="sectionSelect" required>
                                        <option value="">Seleccione secci√≥n...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Materia <span class="text-danger">*</span></label>
                                    <select class="form-control" id="subjectSelect" required>
                                        <option value="">Seleccione materia...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Profesor <span class="text-danger">*</span></label>
                                    <select class="form-control" id="teacherSelect" required>
                                        <option value="">Seleccione profesor...</option>
                                    </select>
                                    <small class="form-text text-muted" id="teacherWorkloadInfo">
                                        Carga horaria: --/40 horas
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Aula <span class="text-danger">*</span></label>
                                    <select class="form-control" id="classroomSelect" required>
                                        <option value="">Seleccione aula...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>D√≠a <span class="text-danger">*</span></label>
                                    <select class="form-control" id="daySelect" required>
                                        <option value="">Seleccione d√≠a...</option>
                                        <option value="lunes">Lunes</option>
                                        <option value="martes">Martes</option>
                                        <option value="miercoles">Mi√©rcoles</option>
                                        <option value="jueves">Jueves</option>
                                        <option value="viernes">Viernes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Per√≠odo <span class="text-danger">*</span></label>
                                    <select class="form-control" id="periodSelect" required>
                                        <option value="">Seleccione per√≠odo...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Conflict Check -->
                        <div class="alert alert-warning" id="conflictAlert" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="conflictMessage"></span>
                        </div>

                        <!-- Success Message -->
                        <div class="alert alert-success" id="successAlert" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            Asignaci√≥n v√°lida - No se detectan conflictos
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveAssignmentBtn" onclick="saveAssignment()">
                        <i class="fas fa-save"></i> Guardar Asignaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflicts Modal -->
    <div class="modal fade" id="conflictsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--danger-color, #dc3545); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle"></i> Conflictos Detectados
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="conflictsList">
                        <!-- Conflicts will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="resolveAllConflicts()">
                        <i class="fas fa-magic"></i> Resolver Autom√°ticamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Venezuelan K12 Compliance Modal -->
    <div class="modal fade" id="complianceModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333;">
                    <h5 class="modal-title">
                        <i class="fas fa-flag"></i> Validaci√≥n Curricular Venezolana K12
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #333;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="complianceContent">
                        <!-- Compliance results will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="generateComplianceReport()">
                        <i class="fas fa-file-alt"></i> Generar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer with Tenant Information -->
    <div class="footer-section">
        <div class="management-container">
            <div class="tenant-info">
                <small class="text-muted">
                    üóÑÔ∏è Base de Datos: <strong>ueipab_2025_data</strong> |
                    üè´ Instituci√≥n: <strong>UEIPAB</strong> |
                    üìÖ A√±o Acad√©mico: <strong>2025-2026</strong> |
                    ‚öôÔ∏è Gesti√≥n de Horarios BiScheduler K12
                </small>
            </div>
        </div>
    </div>

    <!-- Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Schedule Management System
        class ScheduleManager {
            constructor() {
                this.currentView = 'section';
                this.currentTarget = null;
                this.scheduleData = {};
                this.timePeriods = [];
                this.sections = [];
                this.teachers = [];
                this.subjects = [];
                this.classrooms = [];
                this.conflicts = [];
                this.init();
            }

            init() {
                this.initializeTheme();
                this.loadMasterData();
                this.setupEventListeners();
                this.loadDefaultSchedule();
            }

            initializeTheme() {
                const savedTheme = localStorage.getItem('bischeduler-theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);
                this.updateThemeToggle(theme);
            }

            updateThemeToggle(theme) {
                const icon = document.getElementById('darkModeIcon');
                const text = document.getElementById('darkModeText');
                if (icon && text) {
                    if (theme === 'dark') {
                        icon.className = 'fas fa-sun';
                        text.textContent = 'Modo Claro';
                    } else {
                        icon.className = 'fas fa-moon';
                        text.textContent = 'Modo Oscuro';
                    }
                }
            }

            setupEventListeners() {
                // Dark mode toggle
                document.getElementById('darkModeToggle').addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('bischeduler-theme', newTheme);
                    this.updateThemeToggle(newTheme);
                });

                // View selector
                document.getElementById('viewSelector').addEventListener('change', (e) => {
                    this.currentView = e.target.value;
                    this.updateTargetSelector();
                });

                // Target selector
                document.getElementById('targetSelector').addEventListener('change', (e) => {
                    this.currentTarget = e.target.value;
                    if (this.currentTarget) {
                        this.loadSchedule();
                    }
                });

                // Form field changes for conflict checking
                ['sectionSelect', 'teacherSelect', 'classroomSelect', 'daySelect', 'periodSelect'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.checkAssignmentConflicts());
                    }
                });

                // Teacher selection updates workload info
                document.getElementById('teacherSelect').addEventListener('change', (e) => {
                    this.updateTeacherWorkload(e.target.value);
                });
            }

            async loadMasterData() {
                try {
                    // Load real data from API
                    const response = await fetch('/bischeduler/api/schedule/reference-data');
                    const result = await response.json();

                    if (result.success && result.data) {
                        this.teachers = result.data.teachers;
                        this.sections = result.data.sections;
                        this.subjects = result.data.subjects;
                        this.classrooms = result.data.classrooms;
                        this.timePeriods = result.data.time_periods;

                        console.log('Loaded real data:', {
                            teachers: this.teachers.length,
                            sections: this.sections.length,
                            subjects: this.subjects.length,
                            classrooms: this.classrooms.length,
                            timePeriods: this.timePeriods.length
                        });
                    } else {
                        throw new Error('Failed to load reference data: ' + (result.error || 'Unknown error'));
                    }

                    this.populateFormSelects();
                    this.updateTargetSelector();

                    // Auto-load the first available section's schedule for better UX
                    if (this.sections && this.sections.length > 0) {
                        this.currentView = 'section';
                        this.currentTarget = this.sections[0].id;
                        document.getElementById('viewSelect').value = 'section';
                        document.getElementById('targetSelect').value = this.sections[0].id;

                        // Load initial schedule data
                        setTimeout(() => {
                            this.loadSchedule();
                        }, 500);
                    }

                } catch (error) {
                    console.error('Error loading master data:', error);
                    alert('Error cargando datos del sistema. Verifique la conexi√≥n con la base de datos.');
                }
            }

            populateFormSelects() {
                // Populate sections
                const sectionSelect = document.getElementById('sectionSelect');
                sectionSelect.innerHTML = '<option value="">Seleccione secci√≥n...</option>';
                this.sections.forEach(section => {
                    sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                });

                // Populate subjects
                const subjectSelect = document.getElementById('subjectSelect');
                subjectSelect.innerHTML = '<option value="">Seleccione materia...</option>';
                this.subjects.forEach(subject => {
                    subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                });

                // Populate teachers
                const teacherSelect = document.getElementById('teacherSelect');
                teacherSelect.innerHTML = '<option value="">Seleccione profesor...</option>';
                this.teachers.forEach(teacher => {
                    teacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name} (${teacher.specialization})</option>`;
                });

                // Populate classrooms
                const classroomSelect = document.getElementById('classroomSelect');
                classroomSelect.innerHTML = '<option value="">Seleccione aula...</option>';
                this.classrooms.forEach(classroom => {
                    classroomSelect.innerHTML += `<option value="${classroom.id}">${classroom.name} (Cap: ${classroom.capacity})</option>`;
                });

                // Populate periods
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = '<option value="">Seleccione per√≠odo...</option>';
                this.timePeriods.forEach(period => {
                    if (!period.is_break) {
                        periodSelect.innerHTML += `<option value="${period.id}">${period.name}: ${period.start_time} - ${period.end_time}</option>`;
                    }
                });
            }

            updateTargetSelector() {
                const targetSelector = document.getElementById('targetSelector');
                targetSelector.innerHTML = '<option value="">Seleccione...</option>';

                switch (this.currentView) {
                    case 'section':
                        this.sections.forEach(section => {
                            targetSelector.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                        });
                        break;
                    case 'teacher':
                        this.teachers.forEach(teacher => {
                            targetSelector.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
                        });
                        break;
                    case 'classroom':
                        this.classrooms.forEach(classroom => {
                            targetSelector.innerHTML += `<option value="${classroom.id}">${classroom.name}</option>`;
                        });
                        break;
                }
            }

            loadDefaultSchedule() {
                // Load first section by default
                if (this.sections.length > 0) {
                    this.currentTarget = this.sections[0].id;
                    document.getElementById('targetSelector').value = this.currentTarget;
                    this.loadSchedule();
                }
            }

            async loadSchedule() {
                this.showLoading(true);
                try {
                    // Load real schedule data from API
                    const response = await fetch(`/bischeduler/api/schedule/assignments?view_type=${this.currentView}&target_id=${this.currentTarget}`);
                    const result = await response.json();

                    if (result.success) {
                        this.scheduleData = result.schedule_data || {};
                        console.log('Loaded schedule data:', this.scheduleData);
                    } else {
                        console.error('Failed to load schedule:', result.error);
                        this.scheduleData = {};
                    }

                    this.renderScheduleGrid();
                    this.updateStatistics();
                } catch (error) {
                    console.error('Error loading schedule:', error);
                    this.scheduleData = {};
                    this.renderScheduleGrid();
                    this.updateStatistics();
                } finally {
                    this.showLoading(false);
                }
            }


            renderScheduleGrid() {
                const tbody = document.getElementById('scheduleBody');
                tbody.innerHTML = '';

                this.timePeriods.forEach(period => {
                    const row = document.createElement('tr');

                    // Time cell
                    const timeCell = document.createElement('td');
                    timeCell.className = period.is_break ? 'break-cell' : 'time-cell';
                    timeCell.innerHTML = period.is_break ?
                        `<em>${period.name}</em>` :
                        `<strong>${period.name}</strong><br><small>${period.start_time}-${period.end_time}</small>`;
                    row.appendChild(timeCell);

                    // Day cells
                    ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'].forEach(day => {
                        const cell = document.createElement('td');

                        if (period.is_break) {
                            cell.className = 'break-cell';
                            cell.innerHTML = '-';
                        } else {
                            const key = `${day}_${period.id}`;
                            const assignment = this.scheduleData[key];

                            if (assignment) {
                                cell.innerHTML = this.createAssignmentElement(assignment, key);
                            } else {
                                cell.innerHTML = '<div class="empty-slot"><i class="fas fa-plus"></i> Agregar</div>';
                                cell.onclick = () => this.quickAddAssignment(day, period.id);
                            }

                            // Enable drag and drop
                            cell.ondrop = (e) => this.handleDrop(e, day, period.id);
                            cell.ondragover = (e) => this.handleDragOver(e);
                            cell.ondragleave = (e) => this.handleDragLeave(e);
                        }

                        row.appendChild(cell);
                    });

                    tbody.appendChild(row);
                });
            }

            createAssignmentElement(assignment, key) {
                const hasConflict = this.checkForConflicts(key);
                return `
                    <div class="schedule-assignment" draggable="true" ondragstart="scheduleManager.handleDragStart(event, '${key}')">
                        ${hasConflict ? '<div class="conflict-indicator">!</div>' : ''}
                        <div class="assignment-subject">${assignment.subject}</div>
                        <div class="assignment-teacher">${assignment.teacher}</div>
                        <div class="assignment-classroom">${assignment.classroom}</div>
                        <div class="assignment-actions">
                            <button onclick="scheduleManager.editAssignment('${key}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="scheduleManager.deleteAssignment('${key}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            checkForConflicts(key) {
                // Check if assignment has conflict status
                const assignment = this.scheduleData[key];
                return assignment && assignment.conflict_status && assignment.conflict_status !== 'none';
            }

            updateStatistics() {
                const assignments = Object.keys(this.scheduleData).length;
                const totalSlots = this.timePeriods.filter(p => !p.is_break).length * 5; // 5 days
                const freeSlots = totalSlots - assignments;

                // Count real conflicts
                const conflictCount = Object.values(this.scheduleData).filter(assignment =>
                    assignment.conflict_status && assignment.conflict_status !== 'none'
                ).length;

                // Calculate workload hours (40 min periods = 0.67 hours each)
                const workloadHours = (assignments * 0.67).toFixed(1);

                document.getElementById('totalAssignments').textContent = assignments;
                document.getElementById('teacherWorkload').textContent = workloadHours;
                document.getElementById('freeSlots').textContent = freeSlots;
                document.getElementById('conflictCount').textContent = conflictCount;
            }

            quickAddAssignment(day, periodId) {
                // Pre-fill the form with the selected slot and clear editing mode
                document.getElementById('daySelect').value = day;
                document.getElementById('periodSelect').value = periodId;

                // Clear any editing state
                delete document.getElementById('assignmentForm').dataset.editingId;
                document.getElementById('saveAssignmentBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Asignaci√≥n';

                // Clear form alerts
                document.getElementById('conflictAlert').style.display = 'none';
                document.getElementById('successAlert').style.display = 'none';

                this.openAssignmentModal();
            }

            // Drag and Drop handlers
            handleDragStart(e, key) {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('assignmentKey', key);
                e.target.classList.add('dragging');
            }

            handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('drag-over');
                return false;
            }

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            async handleDrop(e, day, periodId) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                e.currentTarget.classList.remove('drag-over');

                const sourceKey = e.dataTransfer.getData('assignmentKey');
                const targetKey = `${day}_${periodId}`;

                if (sourceKey !== targetKey) {
                    const assignment = this.scheduleData[sourceKey];
                    if (assignment && assignment.id) {
                        // Check for conflicts first
                        this.showLoading(true);

                        try {
                            const conflictResponse = await fetch('/bischeduler/api/schedule/conflicts/check', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    teacher_id: assignment.teacher_id || assignment.teacher,
                                    classroom_id: assignment.classroom_id || assignment.classroom,
                                    day_of_week: day,
                                    time_period_id: parseInt(periodId),
                                    exclude_assignment_id: assignment.id
                                })
                            });

                            const conflictResult = await conflictResponse.json();

                            if (conflictResult.success && conflictResult.has_conflicts) {
                                // Show conflict warning
                                const confirmed = confirm(
                                    `‚ö†Ô∏è Movimiento genera conflictos:\n\n${conflictResult.conflicts.map(c => `‚Ä¢ ${c.message}`).join('\n')}\n\n¬øContinuar de todas formas?`
                                );

                                if (!confirmed) {
                                    return false;
                                }
                            }

                            // Update assignment in database
                            const updateResponse = await fetch(`/bischeduler/api/schedule/assignments/${assignment.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    day_of_week: day,
                                    time_period_id: parseInt(periodId)
                                })
                            });

                            const updateResult = await updateResponse.json();

                            if (updateResult.success) {
                                // Update UI immediately
                                this.scheduleData[targetKey] = { ...assignment };
                                delete this.scheduleData[sourceKey];
                                this.renderScheduleGrid();
                                this.updateStatistics();

                                this.showNotification(`Asignaci√≥n movida a ${day} ${this.getTimePeriodName(periodId)}`, 'success');
                            } else {
                                throw new Error(updateResult.error || 'Failed to update assignment');
                            }

                        } catch (error) {
                            console.error('Error moving assignment:', error);
                            this.showNotification('Error al mover la asignaci√≥n: ' + error.message, 'error');
                        } finally {
                            this.showLoading(false);
                        }
                    }
                }

                // Remove dragging class from all elements
                document.querySelectorAll('.dragging').forEach(el => {
                    el.classList.remove('dragging');
                });

                return false;
            }

            getTimePeriodName(periodId) {
                const period = this.timePeriods.find(p => p.id == periodId);
                return period ? `${period.name} (${period.start_time}-${period.end_time})` : 'Unknown Period';
            }

            getCurrentTargetName() {
                if (this.currentView === 'section') {
                    const section = this.sections.find(s => s.id == this.currentTarget);
                    return section ? section.name : 'Secci√≥n Desconocida';
                } else if (this.currentView === 'teacher') {
                    const teacher = this.teachers.find(t => t.id == this.currentTarget);
                    return teacher ? teacher.name : 'Profesor Desconocido';
                } else if (this.currentView === 'classroom') {
                    const classroom = this.classrooms.find(c => c.id == this.currentTarget);
                    return classroom ? classroom.name : 'Aula Desconocida';
                }
                return 'N/A';
            }

            openAssignmentModal() {
                // Clear form when opening for new assignment
                const form = document.getElementById('assignmentForm');
                form.reset();

                // Clear editing state
                delete form.dataset.editingId;
                document.getElementById('saveAssignmentBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Asignaci√≥n';

                // Clear alerts
                document.getElementById('conflictAlert').style.display = 'none';
                document.getElementById('successAlert').style.display = 'none';

                $('#assignmentModal').modal('show');
            }

            updateTeacherWorkload(teacherId) {
                if (teacherId) {
                    const teacher = this.teachers.find(t => t.id == teacherId);
                    if (teacher) {
                        const currentHours = (Math.random() * 30 + 10).toFixed(1); // Demo hours with 1 decimal
                        document.getElementById('teacherWorkloadInfo').textContent =
                            `Carga horaria: ${currentHours}/40 horas`;
                    }
                }
            }

            async saveAssignment() {
                const form = document.getElementById('assignmentForm');
                if (form.checkValidity()) {
                    const data = {
                        section_id: parseInt(document.getElementById('sectionSelect').value),
                        subject_id: parseInt(document.getElementById('subjectSelect').value),
                        teacher_id: parseInt(document.getElementById('teacherSelect').value),
                        classroom_id: parseInt(document.getElementById('classroomSelect').value),
                        day_of_week: document.getElementById('daySelect').value,
                        time_period_id: parseInt(document.getElementById('periodSelect').value)
                    };

                    this.showLoading(true);

                    try {
                        // Save to database via API
                        const response = await fetch('/bischeduler/api/schedule/assignments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            $('#assignmentModal').modal('hide');
                            form.reset();

                            // Clear form alerts
                            document.getElementById('conflictAlert').style.display = 'none';
                            document.getElementById('successAlert').style.display = 'none';

                            // Reload schedule to show new assignment
                            await this.loadSchedule();

                            // Show success message
                            this.showNotification('Asignaci√≥n guardada exitosamente', 'success');
                        } else {
                            // Handle conflicts or errors
                            if (response.status === 409) {
                                document.getElementById('conflictAlert').style.display = 'block';
                                document.getElementById('conflictMessage').innerHTML =
                                    result.conflicts.map(c => `‚Ä¢ ${c.message}`).join('<br>');
                                document.getElementById('successAlert').style.display = 'none';
                            } else {
                                throw new Error(result.error || 'Unknown error');
                            }
                        }

                    } catch (error) {
                        console.error('Error saving assignment:', error);
                        this.showNotification('Error al guardar la asignaci√≥n: ' + error.message, 'error');
                    } finally {
                        this.showLoading(false);
                    }
                } else {
                    form.reportValidity();
                }
            }

            async editAssignment(key) {
                const assignment = this.scheduleData[key];
                if (!assignment || !assignment.id) {
                    this.showNotification('No se pudo cargar la informaci√≥n de la asignaci√≥n', 'error');
                    return;
                }

                // Load assignment data into form
                try {
                    const [day, periodId] = key.split('_');

                    document.getElementById('sectionSelect').value = assignment.section_id;
                    document.getElementById('subjectSelect').value = assignment.subject_id;
                    document.getElementById('teacherSelect').value = assignment.teacher_id;
                    document.getElementById('classroomSelect').value = assignment.classroom_id;
                    document.getElementById('daySelect').value = day;
                    document.getElementById('periodSelect').value = periodId;

                    // Store assignment ID for update
                    document.getElementById('assignmentForm').dataset.editingId = assignment.id;
                    document.getElementById('saveAssignmentBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Asignaci√≥n';

                    $('#assignmentModal').modal('show');

                } catch (error) {
                    console.error('Error loading assignment for edit:', error);
                    this.showNotification('Error al cargar la asignaci√≥n para editar', 'error');
                }
            }

            async updateAssignment(assignmentId, data) {
                this.showLoading(true);

                try {
                    const response = await fetch(`/bischeduler/api/schedule/assignments/${assignmentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        $('#assignmentModal').modal('hide');
                        document.getElementById('assignmentForm').reset();
                        delete document.getElementById('assignmentForm').dataset.editingId;
                        document.getElementById('saveAssignmentBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Asignaci√≥n';

                        // Clear form alerts
                        document.getElementById('conflictAlert').style.display = 'none';
                        document.getElementById('successAlert').style.display = 'none';

                        // Reload schedule
                        await this.loadSchedule();
                        this.showNotification('Asignaci√≥n actualizada exitosamente', 'success');
                    } else {
                        if (response.status === 409) {
                            document.getElementById('conflictAlert').style.display = 'block';
                            document.getElementById('conflictMessage').innerHTML =
                                result.conflicts.map(c => `‚Ä¢ ${c.message}`).join('<br>');
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    }

                } catch (error) {
                    console.error('Error updating assignment:', error);
                    this.showNotification('Error al actualizar la asignaci√≥n: ' + error.message, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async deleteAssignment(key) {
                const assignment = this.scheduleData[key];
                if (!assignment || !assignment.id) {
                    this.showNotification('No se pudo identificar la asignaci√≥n', 'error');
                    return;
                }

                if (!confirm('¬øEst√° seguro de eliminar esta asignaci√≥n?')) {
                    return;
                }

                this.showLoading(true);

                try {
                    const response = await fetch(`/bischeduler/api/schedule/assignments/${assignment.id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Reload schedule to reflect deletion
                        await this.loadSchedule();
                        this.showNotification('Asignaci√≥n eliminada exitosamente', 'success');
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }

                } catch (error) {
                    console.error('Error deleting assignment:', error);
                    this.showNotification('Error al eliminar la asignaci√≥n: ' + error.message, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async checkAssignmentConflicts() {
                const teacherId = document.getElementById('teacherSelect').value;
                const classroomId = document.getElementById('classroomSelect').value;
                const day = document.getElementById('daySelect').value;
                const periodId = document.getElementById('periodSelect').value;

                if (teacherId && classroomId && day && periodId) {
                    try {
                        const data = {
                            teacher_id: parseInt(teacherId),
                            classroom_id: parseInt(classroomId),
                            day_of_week: day,
                            time_period_id: parseInt(periodId)
                        };

                        // If editing, exclude current assignment
                        const editingId = document.getElementById('assignmentForm').dataset.editingId;
                        if (editingId) {
                            data.exclude_assignment_id = parseInt(editingId);
                        }

                        const response = await fetch('/bischeduler/api/schedule/conflicts/check', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (result.success) {
                            if (result.has_conflicts) {
                                document.getElementById('conflictAlert').style.display = 'block';
                                document.getElementById('conflictMessage').innerHTML =
                                    result.conflicts.map(c => `‚Ä¢ ${c.message}`).join('<br>');
                                document.getElementById('successAlert').style.display = 'none';
                            } else {
                                document.getElementById('conflictAlert').style.display = 'none';
                                document.getElementById('successAlert').style.display = 'block';
                            }
                        }

                    } catch (error) {
                        console.error('Error checking conflicts:', error);
                    }
                }
            }

            async loadAllConflicts() {
                try {
                    // Get all assignments for comprehensive conflict detection
                    const allConflicts = [];

                    // Check every assignment against all others
                    for (const [key, assignment] of Object.entries(this.scheduleData)) {
                        if (!assignment.id) continue;

                        const [day, periodId] = key.split('_');

                        // Check this assignment for conflicts
                        const response = await fetch('/bischeduler/api/schedule/conflicts/check', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                teacher_id: assignment.teacher_id || assignment.teacher,
                                classroom_id: assignment.classroom_id || assignment.classroom,
                                day_of_week: day,
                                time_period_id: parseInt(periodId),
                                exclude_assignment_id: assignment.id
                            })
                        });

                        const result = await response.json();

                        if (result.success && result.has_conflicts) {
                            result.conflicts.forEach(conflict => {
                                // Add assignment context to conflict
                                conflict.assignment_key = key;
                                conflict.assignment_info = {
                                    subject: assignment.subject,
                                    teacher: assignment.teacher,
                                    classroom: assignment.classroom,
                                    day: day,
                                    period: periodId
                                };
                                allConflicts.push(conflict);
                            });
                        }
                    }

                    // Remove duplicates (conflicts detected from both sides)
                    const uniqueConflicts = [];
                    const seen = new Set();

                    for (const conflict of allConflicts) {
                        const key = `${conflict.type}_${conflict.message}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniqueConflicts.push(conflict);
                        }
                    }

                    return uniqueConflicts;

                } catch (error) {
                    console.error('Error loading conflicts:', error);
                    throw error;
                }
            }

            showNotification(message, type = 'info') {
                // Create a temporary notification
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.style.maxWidth = '400px';
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                `;

                document.body.appendChild(notification);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }

            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            }
        }

        // Global functions
        const scheduleManager = new ScheduleManager();

        function openAssignmentModal() {
            scheduleManager.openAssignmentModal();
        }

        function saveAssignment() {
            // Check if we're editing or creating
            const editingId = document.getElementById('assignmentForm').dataset.editingId;

            if (editingId) {
                // Update existing assignment
                const data = {
                    section_id: parseInt(document.getElementById('sectionSelect').value),
                    subject_id: parseInt(document.getElementById('subjectSelect').value),
                    teacher_id: parseInt(document.getElementById('teacherSelect').value),
                    classroom_id: parseInt(document.getElementById('classroomSelect').value),
                    day_of_week: document.getElementById('daySelect').value,
                    time_period_id: parseInt(document.getElementById('periodSelect').value)
                };

                scheduleManager.updateAssignment(parseInt(editingId), data);
            } else {
                // Create new assignment
                scheduleManager.saveAssignment();
            }
        }

        async function generateSchedule() {
            const generationType = await showGenerationModal();
            if (!generationType) return;

            scheduleManager.showLoading(true);

            try {
                const response = await fetch('/bischeduler/api/schedule/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        view_type: scheduleManager.currentView,
                        target_id: scheduleManager.currentTarget,
                        generation_type: generationType,
                        academic_year: '2025-2026',
                        preserve_existing: generationType === 'fill_gaps'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload schedule to show generated assignments
                    await scheduleManager.loadSchedule();
                    scheduleManager.showNotification(
                        `‚ú® Se generaron ${result.assignments_created} nuevas asignaciones autom√°ticamente`,
                        'success'
                    );

                    // Show generation summary
                    if (result.summary) {
                        showGenerationSummary(result.summary);
                    }
                } else {
                    throw new Error(result.error || 'Error en la generaci√≥n autom√°tica');
                }

            } catch (error) {
                console.error('Generation error:', error);
                scheduleManager.showNotification('Error en la generaci√≥n autom√°tica: ' + error.message, 'error');
            } finally {
                scheduleManager.showLoading(false);
            }
        }

        function showGenerationModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-magic"></i> Generaci√≥n Autom√°tica de Horarios
                                </h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Algoritmo inteligente</strong> que respeta las regulaciones venezolanas K12
                                </div>

                                <p>Seleccione el tipo de generaci√≥n:</p>
                                <div class="list-group">
                                    <button class="list-group-item list-group-item-action" onclick="selectGenerationType('complete_rebuild')">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                <i class="fas fa-refresh text-primary"></i>
                                                Regeneraci√≥n Completa
                                            </h6>
                                            <small class="text-warning">‚ö†Ô∏è Destructivo</small>
                                        </div>
                                        <p class="mb-1">Elimina todas las asignaciones existentes y genera un horario completamente nuevo</p>
                                        <small class="text-muted">Usa algoritmos de optimizaci√≥n para distribuir equitativamente la carga</small>
                                    </button>

                                    <button class="list-group-item list-group-item-action" onclick="selectGenerationType('fill_gaps')">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                <i class="fas fa-puzzle-piece text-success"></i>
                                                Completar Espacios Libres
                                            </h6>
                                            <small class="text-success">‚úÖ Seguro</small>
                                        </div>
                                        <p class="mb-1">Mantiene las asignaciones existentes y llena los espacios vac√≠os</p>
                                        <small class="text-muted">Ideal para optimizar horarios parcialmente configurados</small>
                                    </button>

                                    <button class="list-group-item list-group-item-action" onclick="selectGenerationType('optimize_workload')">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                <i class="fas fa-balance-scale text-info"></i>
                                                Optimizar Carga Docente
                                            </h6>
                                            <small class="text-info">üìä Inteligente</small>
                                        </div>
                                        <p class="mb-1">Redistribuye asignaciones para balancear la carga de trabajo</p>
                                        <small class="text-muted">Respeta l√≠mite de 40 horas/semana por profesor</small>
                                    </button>
                                </div>

                                <div class="mt-3">
                                    <h6>Criterios de Generaci√≥n:</h6>
                                    <ul class="small text-muted">
                                        <li>L√≠mite de 40 horas semanales por profesor</li>
                                        <li>Sin conflictos de horario (profesor/aula)</li>
                                        <li>Distribuci√≥n equitativa de materias</li>
                                        <li>Respeto por especializaciones docentes</li>
                                        <li>Optimizaci√≥n de uso de aulas</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                $(modal).modal('show');

                window.selectGenerationType = (type) => {
                    $(modal).modal('hide');
                    setTimeout(() => {
                        document.body.removeChild(modal);
                        delete window.selectGenerationType;
                    }, 500);
                    resolve(type);
                };

                $(modal).on('hidden.bs.modal', () => {
                    setTimeout(() => {
                        if (modal.parentNode) {
                            document.body.removeChild(modal);
                        }
                        delete window.selectGenerationType;
                    }, 100);
                    resolve(null);
                });
            });
        }

        function showGenerationSummary(summary) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-check-circle"></i> Generaci√≥n Completada
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <i class="fas fa-calendar-plus fa-3x text-success mb-2"></i>
                                        <h4>${summary.assignments_created || 0}</h4>
                                        <small class="text-muted">Asignaciones Creadas</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <i class="fas fa-users fa-3x text-info mb-2"></i>
                                        <h4>${summary.teachers_assigned || 0}</h4>
                                        <small class="text-muted">Profesores Asignados</small>
                                    </div>
                                </div>
                            </div>

                            ${summary.conflicts_resolved ? `
                                <div class="alert alert-success mt-3">
                                    <i class="fas fa-shield-alt"></i>
                                    Se resolvieron ${summary.conflicts_resolved} conflictos autom√°ticamente
                                </div>
                            ` : ''}

                            <div class="mt-3">
                                <h6>Pr√≥ximos pasos recomendados:</h6>
                                <ul class="small">
                                    <li>Revise las asignaciones generadas</li>
                                    <li>Ejecute detecci√≥n de conflictos</li>
                                    <li>Ajuste manualmente si es necesario</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Entendido</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            $(modal).modal('show');

            $(modal).on('hidden.bs.modal', () => {
                setTimeout(() => {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                }, 100);
            });
        }

        async function checkConflicts() {
            scheduleManager.showLoading(true);

            try {
                // Load all schedule conflicts for current view
                const allConflicts = await scheduleManager.loadAllConflicts();

                // Show conflicts modal
                $('#conflictsModal').modal('show');

                // Populate conflicts list
                const conflictsList = document.getElementById('conflictsList');

                if (allConflicts.length === 0) {
                    conflictsList.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>¬°Excelente!</strong> No se detectaron conflictos en el horario actual.
                        </div>
                        <div class="text-center mt-3">
                            <i class="fas fa-calendar-check fa-3x text-success"></i>
                            <p class="mt-2 text-muted">El horario cumple con todas las restricciones venezolanas K12.</p>
                        </div>
                    `;
                } else {
                    let conflictsHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Se detectaron ${allConflicts.length} conflicto(s)</strong> en el horario actual.
                        </div>
                    `;

                    allConflicts.forEach((conflict, index) => {
                        const iconClass = {
                            'teacher_conflict': 'fas fa-user-times text-danger',
                            'classroom_conflict': 'fas fa-door-closed text-warning',
                            'workload_limit': 'fas fa-clock text-info',
                            'schedule_overlap': 'fas fa-calendar-times text-danger'
                        }[conflict.type] || 'fas fa-exclamation-triangle text-warning';

                        conflictsHtml += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="mr-3">
                                            <i class="${iconClass} fa-2x"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="card-title">
                                                ${getConflictTitle(conflict.type)}
                                            </h6>
                                            <p class="card-text">${conflict.message}</p>
                                            ${conflict.current_workload ? `
                                                <div class="progress mb-2">
                                                    <div class="progress-bar bg-warning" style="width: ${Math.min(conflict.current_workload / 40 * 100, 100)}%">
                                                        ${conflict.current_workload.toFixed(1)} / 40 horas
                                                    </div>
                                                </div>
                                            ` : ''}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i>
                                                    ${getConflictSolution(conflict.type)}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="ml-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="resolveConflict(${index})">
                                                <i class="fas fa-magic"></i> Resolver
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    conflictsList.innerHTML = conflictsHtml;
                }

            } catch (error) {
                console.error('Error loading conflicts:', error);
                const conflictsList = document.getElementById('conflictsList');
                conflictsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error al cargar conflictos: ${error.message}
                    </div>
                `;
            } finally {
                scheduleManager.showLoading(false);
            }
        }

        function getConflictTitle(type) {
            const titles = {
                'teacher_conflict': 'Conflicto de Profesor',
                'classroom_conflict': 'Conflicto de Aula',
                'workload_limit': 'L√≠mite de Carga Horaria',
                'schedule_overlap': 'Solapamiento de Horario'
            };
            return titles[type] || 'Conflicto Detectado';
        }

        function getConflictSolution(type) {
            const solutions = {
                'teacher_conflict': 'Reasigne el profesor a otro per√≠odo o cambie la asignaci√≥n existente.',
                'classroom_conflict': 'Seleccione un aula diferente o cambie el per√≠odo de tiempo.',
                'workload_limit': 'Redistribuya las clases del profesor para no exceder 40 horas semanales.',
                'schedule_overlap': 'Ajuste los horarios para evitar solapamientos.'
            };
            return solutions[type] || 'Revise y ajuste la asignaci√≥n seg√∫n las reglas venezolanas K12.';
        }

        async function resolveConflict(conflictIndex) {
            try {
                scheduleManager.showNotification('Funci√≥n de resoluci√≥n autom√°tica en desarrollo', 'info');
                // Future: Implement intelligent conflict resolution algorithms
            } catch (error) {
                scheduleManager.showNotification('Error al resolver conflicto: ' + error.message, 'error');
            }
        }

        async function resolveAllConflicts() {
            if (!confirm('¬øDesea intentar resolver autom√°ticamente todos los conflictos detectados?')) {
                return;
            }

            scheduleManager.showLoading(true);

            try {
                // Future: Implement batch conflict resolution
                scheduleManager.showNotification('Resoluci√≥n autom√°tica de conflictos en desarrollo (Fase 3)', 'info');

                // For now, just refresh the conflicts view
                setTimeout(async () => {
                    await checkConflicts();
                }, 1000);

            } catch (error) {
                scheduleManager.showNotification('Error en resoluci√≥n autom√°tica: ' + error.message, 'error');
            } finally {
                scheduleManager.showLoading(false);
            }
        }

        async function exportSchedule() {
            try {
                // Check if we have schedule data to export BEFORE showing modal
                if (!scheduleManager.scheduleData || Object.keys(scheduleManager.scheduleData).length === 0) {
                    // Try to load a default section's schedule
                    if (scheduleManager.sections && scheduleManager.sections.length > 0) {
                        scheduleManager.showNotification('Cargando datos para exportar...', 'info');
                        scheduleManager.currentView = 'section';
                        scheduleManager.currentTarget = scheduleManager.sections[0].id;

                        // Update UI to show the selected section
                        document.getElementById('viewSelect').value = 'section';
                        document.getElementById('targetSelect').value = scheduleManager.sections[0].id;

                        // Load schedule data
                        await scheduleManager.loadSchedule();

                        // Check again if we now have data
                        if (!scheduleManager.scheduleData || Object.keys(scheduleManager.scheduleData).length === 0) {
                            scheduleManager.showNotification('No hay horarios configurados en el sistema. Configure primero algunos horarios.', 'warning');
                            return;
                        }
                    } else {
                        scheduleManager.showNotification('No hay datos disponibles para exportar. Configure primero algunas secciones y horarios.', 'warning');
                        return;
                    }
                }

                const exportType = await showExportModal();
                if (!exportType) return;

                scheduleManager.showLoading(true);

                // For fallback exports, we'll use the current schedule data
                const targetId = scheduleManager.currentTarget || 'all';
                const viewType = scheduleManager.currentView || 'general';

                // For all formats, use client-side export for now
                if (exportType === 'csv' || exportType === 'xlsx') {
                    exportToCSV();
                    scheduleManager.showNotification('Horario exportado como CSV', 'success');
                    return;
                } else if (exportType === 'pdf') {
                    exportToHTML();
                    scheduleManager.showNotification('Horario exportado como HTML (abrir en navegador para imprimir como PDF)', 'success');
                    return;
                }

                // If API is needed in the future, try the full API endpoint
                const response = await fetch('/bischeduler/api/schedule/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        view_type: viewType,
                        target_id: targetId,
                        format: exportType,
                        academic_year: '2025-2026'
                    })
                });

                if (response.ok) {
                    // Handle file download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `horario_${scheduleManager.currentView}_${new Date().toISOString().split('T')[0]}.${exportType}`;
                    document.body.appendChild(a);
                    a.click();

                    // Clean up
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        if (a.parentNode) {
                            document.body.removeChild(a);
                        }
                    }, 100);

                    scheduleManager.showNotification('Horario exportado exitosamente', 'success');
                } else {
                    // Fallback to CSV if API fails
                    console.warn('API export failed, falling back to CSV');
                    exportToCSV();
                    scheduleManager.showNotification('Exportado como CSV (API en desarrollo)', 'info');
                }

            } catch (error) {
                console.error('Export error:', error);
                // Fallback to CSV export
                try {
                    exportToCSV();
                    scheduleManager.showNotification('Exportado como CSV debido a error t√©cnico', 'warning');
                } catch (csvError) {
                    scheduleManager.showNotification('Error al exportar: ' + error.message, 'error');
                }
            } finally {
                scheduleManager.showLoading(false);
            }
        }

        function exportToCSV() {
            // Create CSV from current schedule data
            const scheduleData = scheduleManager.scheduleData;
            const csvContent = [];

            // CSV Headers
            csvContent.push(['D√≠a', 'Hora', 'Materia', 'Profesor', 'Aula', 'Secci√≥n']);

            // Add data rows
            Object.entries(scheduleData).forEach(([key, assignment]) => {
                const [day, periodId] = key.split('_');
                const period = scheduleManager.timePeriods.find(p => p.id == periodId);
                const timeString = period ? `${period.start_time}-${period.end_time}` : 'N/A';

                csvContent.push([
                    day.charAt(0).toUpperCase() + day.slice(1),
                    timeString,
                    assignment.subject || 'N/A',
                    assignment.teacher || 'N/A',
                    assignment.classroom || 'N/A',
                    scheduleManager.getCurrentTargetName()
                ]);
            });

            // Create and download CSV
            const csvString = csvContent.map(row =>
                row.map(field => `"${field}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `horario_${scheduleManager.currentView}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                if (a.parentNode) {
                    document.body.removeChild(a);
                }
            }, 100);
        }

        function exportToHTML() {
            // Create a professional HTML schedule that can be printed as PDF
            const scheduleData = scheduleManager.scheduleData;
            const targetName = scheduleManager.getCurrentTargetName();
            const currentDate = new Date().toLocaleDateString('es-VE');

            // Group data by day
            const daySchedule = {};
            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];

            days.forEach(day => {
                daySchedule[day] = [];
            });

            Object.entries(scheduleData).forEach(([key, assignment]) => {
                const [day, periodId] = key.split('_');
                const period = scheduleManager.timePeriods.find(p => p.id == periodId);

                if (period && daySchedule[day]) {
                    daySchedule[day].push({
                        time: `${period.start_time} - ${period.end_time}`,
                        subject: assignment.subject || 'N/A',
                        teacher: assignment.teacher || 'N/A',
                        classroom: assignment.classroom || 'N/A',
                        period: period
                    });
                }
            });

            // Sort by time for each day
            days.forEach(day => {
                daySchedule[day].sort((a, b) => a.period.start_time.localeCompare(b.period.start_time));
            });

            const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario Acad√©mico - ${targetName}</title>
    <style>
        @media print {
            @page { margin: 1cm; }
            body { margin: 0; }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            line-height: 1.4;
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #003366;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #003366;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .header .subtitle {
            color: #666;
            font-size: 16px;
            margin: 5px 0;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .schedule-table th {
            background: linear-gradient(135deg, #003366, #004080);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #002244;
        }

        .schedule-table td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: top;
        }

        .schedule-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .schedule-table tr:hover {
            background-color: #e8f4fd;
        }

        .time-column {
            background-color: #f1f3f4;
            font-weight: bold;
            width: 120px;
        }

        .class-info {
            min-height: 60px;
            padding: 5px;
        }

        .subject {
            font-weight: bold;
            color: #003366;
            margin-bottom: 3px;
        }

        .teacher {
            color: #666;
            font-size: 0.9em;
        }

        .classroom {
            color: #999;
            font-size: 0.8em;
            font-style: italic;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #003366;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Horario Acad√©mico</h1>
        <div class="subtitle">üè´ UEIPAB - Unidad Educativa Instituto Privado Adventista Barquisimeto</div>
        <div class="subtitle">üìÖ A√±o Acad√©mico 2025-2026</div>
        <div class="subtitle"><strong>${targetName}</strong></div>
        <div class="subtitle">Generado: ${currentDate}</div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-number">${Object.keys(scheduleData).length}</div>
            <div class="stat-label">Total Per√≠odos</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">${[...new Set(Object.values(scheduleData).map(a => a.subject))].length}</div>
            <div class="stat-label">Materias</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">${[...new Set(Object.values(scheduleData).map(a => a.teacher))].length}</div>
            <div class="stat-label">Profesores</div>
        </div>
    </div>

    <table class="schedule-table">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Mi√©rcoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
        </thead>
        <tbody>
            ${scheduleManager.timePeriods.filter(p => !p.is_break).map(period => `
                <tr>
                    <td class="time-column">
                        ${period.start_time} - ${period.end_time}
                        <br><small>${period.name}</small>
                    </td>
                    ${days.map(day => {
                        const assignment = daySchedule[day].find(a => a.period.id == period.id);
                        return assignment ? `
                            <td>
                                <div class="class-info">
                                    <div class="subject">${assignment.subject}</div>
                                    <div class="teacher">${assignment.teacher}</div>
                                    <div class="classroom">${assignment.classroom}</div>
                                </div>
                            </td>
                        ` : '<td><div class="class-info">-</div></td>';
                    }).join('')}
                </tr>
            `).join('')}
        </tbody>
    </table>

    <div class="footer">
        <p><strong>BiScheduler</strong> - Sistema de Gesti√≥n de Horarios K12 Venezolano</p>
        <p>Generado autom√°ticamente el ${currentDate} | Para convertir a PDF: Archivo ‚Üí Imprimir ‚Üí Guardar como PDF</p>
    </div>
</body>
</html>`;

            // Create and download HTML file
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `horario_${scheduleManager.currentView || 'general'}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                if (a.parentNode) {
                    document.body.removeChild(a);
                }
            }, 100);
        }

        function showExportModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-file-export"></i> Exportar Horario
                                </h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Exportando:</strong> ${scheduleManager.getCurrentTargetName()}
                                    (${Object.keys(scheduleManager.scheduleData || {}).length} per√≠odos)
                                </div>
                                <p>Seleccione el formato de exportaci√≥n:</p>
                                <div class="list-group">
                                    <button class="list-group-item list-group-item-action" onclick="selectExportType('xlsx')">
                                        <i class="fas fa-file-excel text-success"></i>
                                        <strong>Excel (.xlsx)</strong>
                                        <small class="d-block text-muted">Formato est√°ndar para an√°lisis y edici√≥n</small>
                                    </button>
                                    <button class="list-group-item list-group-item-action" onclick="selectExportType('pdf')">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                        <strong>PDF (.pdf)</strong>
                                        <small class="d-block text-muted">Formato de presentaci√≥n e impresi√≥n</small>
                                    </button>
                                    <button class="list-group-item list-group-item-action" onclick="selectExportType('csv')">
                                        <i class="fas fa-file-csv text-info"></i>
                                        <strong>CSV (.csv)</strong>
                                        <small class="d-block text-muted">Datos separados por comas</small>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                $(modal).modal('show');

                let resolved = false;

                window.selectExportType = (type) => {
                    if (resolved) return;
                    resolved = true;

                    $(modal).modal('hide');
                    setTimeout(() => {
                        try {
                            if (modal.parentNode) {
                                document.body.removeChild(modal);
                            }
                        } catch (e) {
                            console.warn('Modal cleanup warning:', e.message);
                        }
                        delete window.selectExportType;
                    }, 500);
                    resolve(type);
                };

                $(modal).on('hidden.bs.modal', () => {
                    if (resolved) return;
                    resolved = true;

                    setTimeout(() => {
                        try {
                            if (modal.parentNode) {
                                document.body.removeChild(modal);
                            }
                        } catch (e) {
                            console.warn('Modal cleanup warning:', e.message);
                        }
                        delete window.selectExportType;
                    }, 100);
                    resolve(null);
                });
            });
        }

        function printSchedule() {
            window.print();
        }

        async function validateVenezuelanK12() {
            scheduleManager.showLoading(true);

            try {
                const response = await fetch('/bischeduler/api/schedule/validate/venezuelan-k12', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        view_type: scheduleManager.currentView,
                        target_id: scheduleManager.currentTarget,
                        academic_year: '2025-2026'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showComplianceResults(result);
                    $('#complianceModal').modal('show');
                } else {
                    throw new Error(result.error || 'Error en validaci√≥n');
                }

            } catch (error) {
                console.error('Compliance validation error:', error);
                scheduleManager.showNotification('Error en validaci√≥n curricular: ' + error.message, 'error');
            } finally {
                scheduleManager.showLoading(false);
            }
        }

        function showComplianceResults(result) {
            const complianceContent = document.getElementById('complianceContent');
            const { compliance_score, violations, summary, recommendations } = result;

            let statusColor = 'success';
            let statusIcon = 'fas fa-check-circle';
            let statusText = 'CUMPLE COMPLETAMENTE';

            if (compliance_score < 60) {
                statusColor = 'danger';
                statusIcon = 'fas fa-times-circle';
                statusText = 'NO CUMPLE - ACCI√ìN REQUERIDA';
            } else if (compliance_score < 80) {
                statusColor = 'warning';
                statusIcon = 'fas fa-exclamation-triangle';
                statusText = 'CUMPLE PARCIALMENTE';
            } else if (compliance_score < 100) {
                statusColor = 'info';
                statusIcon = 'fas fa-info-circle';
                statusText = 'CUMPLE CON OBSERVACIONES';
            }

            let violationsHtml = '';
            if (violations && violations.length > 0) {
                violationsHtml = `
                    <div class="mt-4">
                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Violaciones Detectadas</h6>
                        <div class="accordion" id="violationsAccordion">
                `;

                violations.forEach((violation, index) => {
                    const severityColor = violation.severity === 'critical' ? 'danger' : 'warning';
                    violationsHtml += `
                        <div class="card">
                            <div class="card-header" id="violation${index}">
                                <h6 class="mb-0">
                                    <button class="btn btn-link text-${severityColor}" type="button" data-toggle="collapse" data-target="#collapse${index}">
                                        <i class="fas fa-${violation.severity === 'critical' ? 'times-circle' : 'exclamation-triangle'}"></i>
                                        ${violation.message}
                                        <span class="badge badge-${severityColor} ml-2">${violation.severity.toUpperCase()}</span>
                                    </button>
                                </h6>
                            </div>
                            <div id="collapse${index}" class="collapse" data-parent="#violationsAccordion">
                                <div class="card-body">
                                    <p><strong>Regulaci√≥n:</strong> ${violation.regulation}</p>
                                    ${violation.current_hours ? `<p><strong>Horas actuales:</strong> ${violation.current_hours} / ${violation.max_hours}</p>` : ''}
                                    ${violation.current_periods ? `<p><strong>Per√≠odos actuales:</strong> ${violation.current_periods} / ${violation.required_periods}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                violationsHtml += '</div></div>';
            }

            let recommendationsHtml = '';
            if (recommendations && recommendations.length > 0) {
                recommendationsHtml = `
                    <div class="mt-4">
                        <h6><i class="fas fa-lightbulb text-info"></i> Recomendaciones</h6>
                        <ul class="list-group list-group-flush">
                            ${recommendations.map(rec => `
                                <li class="list-group-item border-left-info">
                                    <i class="fas fa-arrow-right text-info mr-2"></i> ${rec}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            complianceContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="alert alert-${statusColor} d-flex align-items-center">
                            <i class="${statusIcon} fa-2x mr-3"></i>
                            <div>
                                <h5 class="mb-1">Puntuaci√≥n de Cumplimiento: ${compliance_score}/100</h5>
                                <p class="mb-0">${statusText}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">Resumen</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-danger">
                                            <i class="fas fa-times-circle fa-2x"></i>
                                            <div><strong>${summary.critical_violations}</strong></div>
                                            <small>Cr√≠ticas</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-warning">
                                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                                            <div><strong>${summary.warning_violations}</strong></div>
                                            <small>Advertencias</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6><i class="fas fa-gavel text-primary"></i> Regulaciones Verificadas</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> L√≠mite carga horaria docente (40h)</li>
                                <li><i class="fas fa-check text-success"></i> Distribuci√≥n de materias b√°sicas</li>
                                <li><i class="fas fa-check text-success"></i> Estructura bimodal venezolana</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Contenido apropiado por grado</li>
                                <li><i class="fas fa-check text-success"></i> Curr√≠culo B√°sico Nacional</li>
                                <li><i class="fas fa-check text-success"></i> Resoluciones ministeriales</li>
                            </ul>
                        </div>
                    </div>
                </div>

                ${violationsHtml}
                ${recommendationsHtml}

                <div class="mt-4 p-3 bg-light rounded">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        <strong>Nota:</strong> Esta validaci√≥n verifica el cumplimiento con las regulaciones del Sistema Educativo Bolivariano de Venezuela.
                        Para certificaci√≥n oficial, consulte con las autoridades educativas competentes.
                    </small>
                </div>
            `;
        }

        function generateComplianceReport() {
            scheduleManager.showNotification('Generaci√≥n de reporte de cumplimiento en desarrollo', 'info');
            // Future: Generate PDF compliance report
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            window.location.href = '/bischeduler/login';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Schedule Management System initialized');
        });
    </script>
</body>
</html>