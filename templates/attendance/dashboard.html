<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia - BiScheduler</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìã%3C/text%3E%3C/svg%3E">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/bischeduler/static/css/styles.css" rel="stylesheet">
    <link href="/bischeduler/static/css/dark-mode.css" rel="stylesheet">
    <style>
        /* Attendance specific styles with dark mode support */
        .attendance-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        .attendance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color-lg);
        }

        /* Status indicators with dark mode support */
        .status-excellent { border-left: 4px solid var(--success-color); }
        .status-good { border-left: 4px solid #6f42c1; }
        .status-concerning { border-left: 4px solid var(--warning-color); }
        .status-critical { border-left: 4px solid var(--danger-color); }

        /* Dark mode overrides for Bootstrap cards */
        [data-theme="dark"] .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-body {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-title {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .card-text {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .badge {
            background-color: var(--primary-color) !important;
            color: var(--text-inverse) !important;
        }

        /* Fix modal dark mode */
        [data-theme="dark"] .modal-content {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .modal-header {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .modal-body {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .table {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .table td,
        [data-theme="dark"] .table th {
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .table-responsive {
            background-color: var(--card-bg) !important;
        }

        /* Form controls dark mode */
        [data-theme="dark"] .form-control {
            background-color: var(--input-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .form-control:focus {
            background-color: var(--input-bg) !important;
            border-color: var(--primary-color) !important;
            color: var(--text-primary) !important;
            box-shadow: 0 0 0 0.2rem rgba(77, 121, 164, 0.25) !important;
        }

        [data-theme="dark"] .form-label {
            color: var(--text-primary) !important;
        }

        /* Spinner dark mode */
        [data-theme="dark"] .spinner-border {
            color: var(--primary-color) !important;
        }

        /* Fix dropdown positioning and z-index */
        .user-bar .dropdown {
            position: relative;
        }

        .user-bar .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1050 !important;
            min-width: 200px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color-lg);
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] .user-bar .dropdown-menu {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        .user-bar .dropdown-item {
            padding: 10px 15px;
            color: var(--text-primary) !important;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .user-bar .dropdown-item:hover {
            background-color: var(--hover-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .user-bar .dropdown-item {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .user-bar .dropdown-item:hover {
            background-color: var(--hover-bg) !important;
            color: var(--text-primary) !important;
        }

        .user-bar .dropdown-divider {
            margin: 5px 0;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .user-bar .dropdown-divider {
            border-color: var(--border-color) !important;
        }

        /* Fix user bar z-index to ensure it's above other content */
        .user-bar {
            z-index: 1000 !important;
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            backdrop-filter: blur(10px);
            display: flex !important;
            align-items: center !important;
            gap: 15px !important;
            padding: 10px 20px !important;
            border-radius: 25px !important;
            background: var(--card-bg) !important;
            box-shadow: 0 4px 15px var(--shadow-color-lg) !important;
            border: 1px solid var(--border-color) !important;
        }

        [data-theme="dark"] .user-bar {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* Dropdown show state */
        .user-bar .dropdown-menu.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }

        /* Hide dropdown by default */
        .user-bar .dropdown-menu {
            display: none;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        /* Dropdown toggle button styling */
        .user-bar .user-dropdown-toggle {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 8px !important;
            color: var(--text-primary) !important;
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
        }

        .user-bar .user-dropdown-toggle:hover,
        .user-bar .user-dropdown-toggle:focus,
        .user-bar .user-dropdown-toggle:active {
            background: var(--hover-bg) !important;
            border: none !important;
            box-shadow: none !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .user-bar .user-dropdown-toggle {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .user-bar .user-dropdown-toggle:hover,
        [data-theme="dark"] .user-bar .user-dropdown-toggle:focus,
        [data-theme="dark"] .user-bar .user-dropdown-toggle:active {
            background: var(--hover-bg) !important;
            color: var(--text-primary) !important;
        }

        /* Body and container background */
        body {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        [data-theme="dark"] body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .container-fluid {
            background-color: var(--bg-primary) !important;
        }

        /* Button styling */
        [data-theme="dark"] .btn-outline-primary {
            color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        [data-theme="dark"] .btn-outline-primary:hover {
            color: var(--text-inverse) !important;
            background-color: var(--primary-color) !important;
        }

        [data-theme="dark"] .btn-outline-secondary {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .btn-outline-secondary:hover {
            color: var(--text-primary) !important;
            background-color: var(--bg-secondary) !important;
        }
    </style>
</head>
<body>
    <div class="user-bar">
        <div class="user-info">
            <div class="user-name">Profesor UEIPAB</div>
            <div class="user-role">Control de Asistencia</div>
        </div>
        <div class="user-actions">
            <div class="dropdown">
                <button class="btn user-dropdown-toggle" type="button" id="userDropdown" aria-expanded="false">
                    <i class="bi bi-person-circle"></i>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/bischeduler/dashboard"><i class="bi bi-speedometer2"></i> Dashboard Principal</a></li>
                    <li><a class="dropdown-item" href="/bischeduler/attendance/admin"><i class="bi bi-graph-up"></i> Panel Administrativo</a></li>
                    <li><a class="dropdown-item" href="/bischeduler/schedule-optimizer"><i class="bi bi-robot"></i> Optimizador IA</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/bischeduler/logout"><i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="toggleTheme()" title="Cambiar tema">
                <i class="bi bi-moon-stars" id="theme-icon"></i>
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="bi bi-person-check"></i> Control de Asistencia</h2>
                        <p class="text-muted">Sistema de Monitoreo de Ausencias Venezolano - Cumplimiento Gubernamental</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="loadSections()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                        <a href="/bischeduler/attendance/reports" class="btn btn-outline-primary">
                            <i class="bi bi-graph-up"></i> Reportes
                        </a>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-people display-4 text-primary"></i>
                                <h5 class="card-title mt-2">Estudiantes Activos</h5>
                                <p class="card-text display-6" id="totalStudents">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-calendar-check display-4 text-success"></i>
                                <h5 class="card-title mt-2">Asistencia Promedio</h5>
                                <p class="card-text display-6" id="averageAttendance">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                                <h5 class="card-title mt-2">Alertas Activas</h5>
                                <p class="card-text display-6" id="activeAlerts">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-file-earmark-excel display-4 text-info"></i>
                                <h5 class="card-title mt-2">Reportes Matr√≠cula</h5>
                                <p class="card-text display-6" id="monthlyReports">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="attendanceDate" class="form-label">Fecha de Asistencia:</label>
                        <input type="date" class="form-control" id="attendanceDate" value="">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="setToday()">Hoy</button>
                            <button class="btn btn-outline-secondary" onclick="setPrevious()">Ayer</button>
                        </div>
                    </div>
                </div>

                <!-- Sections List -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-collection"></i> Secciones Disponibles</h5>
                    </div>
                    <div class="card-body">
                        <div id="sectionsContainer" class="row">
                            <div class="col-12 text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p>Cargando secciones...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;

            // Load sections
            loadSections();

            // Load stats
            loadStats();
        });

        function loadSections() {
            fetch('/bischeduler/attendance/api/sections')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('sectionsContainer');

                    // Check if response has error
                    if (data.error) {
                        container.innerHTML = `
                            <div class="col-12 text-center">
                                <p class="text-danger">Error: ${data.message}</p>
                            </div>
                        `;
                        return;
                    }

                    // Ensure data is an array
                    const sections = Array.isArray(data) ? data : [];

                    if (sections.length === 0) {
                        container.innerHTML = `
                            <div class="col-12 text-center">
                                <p class="text-muted">No hay secciones disponibles</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = sections.map(section => `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card attendance-card h-100" onclick="openAttendance(${section.id})">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-people"></i> ${section.name}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">Grado ${section.grade_level}</small><br>
                                        <span class="badge bg-primary">${section.student_count} estudiantes</span>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAttendance(${section.id})">
                                            <i class="bi bi-check-square"></i> Marcar Asistencia
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); viewSummary(${section.id})">
                                            <i class="bi bi-graph-up"></i> Ver Resumen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading sections:', error);
                    document.getElementById('sectionsContainer').innerHTML = `
                        <div class="col-12 text-center">
                            <p class="text-danger">Error al cargar secciones: ${error.message}</p>
                        </div>
                    `;
                });
        }

        function loadStats() {
            // TODO: Implement API endpoints for statistics
            document.getElementById('totalStudents').textContent = '180';
            document.getElementById('averageAttendance').textContent = '87%';
            document.getElementById('activeAlerts').textContent = '3';
            document.getElementById('monthlyReports').textContent = '5';
        }

        function openAttendance(sectionId) {
            const date = document.getElementById('attendanceDate').value;
            window.location.href = `/bischeduler/attendance/mark/${sectionId}?date=${date}`;
        }

        function viewSummary(sectionId) {
            // Open modal or navigate to summary page
            fetch(`/bischeduler/attendance/api/attendance/summary/${sectionId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if response has error
                    if (data.error) {
                        alert(`Error: ${data.message}`);
                        return;
                    }
                    showSummaryModal(data);
                })
                .catch(error => {
                    console.error('Error loading summary:', error);
                    alert(`Error al cargar el resumen: ${error.message}`);
                });
        }

        function showSummaryModal(data) {
            // Create and show modal with attendance summary
            const modalHtml = `
                <div class="modal fade" id="summaryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Resumen de Asistencia</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Promedio de la Secci√≥n:</strong> ${data.section_average.toFixed(1)}%</p>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Estudiante</th>
                                                <th>Asistencia</th>
                                                <th>D√≠as Presente</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.students.map(student => `
                                                <tr class="status-${student.status}">
                                                    <td>${student.student_name}</td>
                                                    <td>${student.attendance_percentage}%</td>
                                                    <td>${student.present_days}/${student.total_days}</td>
                                                    <td>
                                                        <span class="badge bg-${student.status === 'excellent' ? 'success' : student.status === 'good' ? 'primary' : student.status === 'concerning' ? 'warning' : 'danger'}">
                                                            ${student.status === 'excellent' ? 'Excelente' : student.status === 'good' ? 'Bueno' : student.status === 'concerning' ? 'Preocupante' : 'Cr√≠tico'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal
            const existingModal = document.getElementById('summaryModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('summaryModal'));
            modal.show();
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
        }

        function setPrevious() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('attendanceDate').value = yesterday.toISOString().split('T')[0];
        }

        // Theme toggle function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const icon = document.getElementById('theme-icon');
            icon.className = newTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';

        // Manual dropdown functionality (Bootstrap conflict fix)
        window.addEventListener('load', function() {
            const dropdownToggle = document.getElementById('userDropdown');

            if (dropdownToggle) {
                // Remove Bootstrap data attributes to prevent conflicts
                dropdownToggle.removeAttribute('data-bs-toggle');

                const dropdownMenu = dropdownToggle.nextElementSibling;

                if (dropdownMenu) {
                    console.log('Dropdown elements found - using manual control');

                    // Click handler for dropdown toggle
                    dropdownToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const isOpen = dropdownMenu.classList.contains('show');
                        console.log('Dropdown clicked, currently open:', isOpen);

                        if (!isOpen) {
                            // Open dropdown
                            dropdownMenu.classList.add('show');
                            dropdownToggle.setAttribute('aria-expanded', 'true');
                            console.log('Dropdown opened');
                        } else {
                            // Close dropdown
                            dropdownMenu.classList.remove('show');
                            dropdownToggle.setAttribute('aria-expanded', 'false');
                            console.log('Dropdown closed');
                        }
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                            if (dropdownMenu.classList.contains('show')) {
                                dropdownMenu.classList.remove('show');
                                dropdownToggle.setAttribute('aria-expanded', 'false');
                                console.log('Dropdown closed by outside click');
                            }
                        }
                    });

                    // Prevent dropdown menu clicks from closing the dropdown
                    dropdownMenu.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                } else {
                    console.error('Dropdown menu not found');
                }
            } else {
                console.error('Dropdown toggle button not found');
            }
        });
    </script>
</body>
</html>